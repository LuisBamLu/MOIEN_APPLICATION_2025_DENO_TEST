<script>
    // -- IMPORTS

    import { getFilteredArray, getOptionArray } from '$lib/base';
    import
    {
        handleCreateSpace,
        handleDeleteSpace,
        handleEditSpace,
        isSpaceModalOpen,
        loadSpaceArray,
        profileArrayStore,
        propertyArrayStore,
        selectedSpaceStore,
        spaceArrayStore,
        spaceTypeArrayStore,
        toggleSpaceModal,
        isFormModified as isSpaceFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        hasMorePage,
        isSpaceLoading,
        isSubmitting
    }
    from '$store/spaceStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import ConfirmModal from '$component/element/ConfirmModal.svelte';
    import Input from '$component/element/Input.svelte';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import Select from '$component/element/Select.svelte';
    import { getLocalizedText } from 'senselogic-gist';
    import { languageTagStore } from '$store/languageTagStore';
    import { urlParamsStore } from '$store/urlParamsStore';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-space-label',
        addTitle: 'add-space-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        property:
        {
            type: 'text',
            name: 'Property',
            value: ''
        },
        spaceType:
        {
            type: 'select',
            name: 'Type',
            optionArray: [],
            value: ''
        },
        name:
        {
            type: 'text',
            name: 'Name',
            value: ''
        },
        description:
        {
            type: 'text',
            name: 'Description',
            value: ''
        },
        floorNumber:
        {
            type: 'number',
            name: 'Floor',
            value: ''
        },
        area:
        {
            type: 'number',
            name: 'Area',
            value: ''
        },
        userProfile:
        {
            type: 'text',
            name: 'Owner',
            value: ''
        },
        userId:
        {
            type: 'text',
            name: 'User ID',
            value: ''
        },
        propertyId:
        {
            type: 'text',
            name: 'Property ID',
            value: ''
        }
    };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'ID', type: 'text' },
            propertyId: { columnLabel: 'Property ID', type: 'text' },
            typeId: { columnLabel: 'Space type', type: 'select', optionArray: [] },
            name: { columnLabel: 'Name', type: 'text' },
            description: { columnLabel: 'Description', type: 'text' },
            floorNumber: { columnLabel: 'Floor', type: 'text' },
            area: { columnLabel: 'Area', type: 'text' },
            userId: { columnLabel: 'Owner', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
        });
    let tableConfigMap =
        $derived({
            headerArray:
                [
                    { type: 'profile', label: 'Profile', key: 'userProfile' },
                    { type: 'property', label: 'Property', key: 'property' },
                    { type: 'text', label: 'Type', key: 'spaceType' },
                    { type: 'text', label: 'Name', key: 'name' },
                    { type: 'text', label: 'Description', key: 'description' },
                    { type: 'number', label: 'Floor', key: 'floorNumber' },
                    { type: 'number', label: 'Area', key: 'area' }
                ],
            dataArray: $spaceArrayStore
        });

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.typeId.optionArray = getOptionArray( $spaceTypeArrayStore );
    }

    // ~~

    function handleUpdateSpaceLocalizedInput(
        event
        )
    {
        handleChange();
        selectedSpaceStore.update( ( space ) => ( { ...space, [ event.detail.name ]: event.detail.text } ) );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isSpaceLoading && $hasMorePage )
        {
            await loadSpaceArray( page );
            arrayProcessing();
            $spaceArrayStore = getFilteredArray( $spaceArrayStore, $urlParamsStore, filterParameterByKeyMap, $languageTagStore );
        }
    }
</script>

<ConfirmModal
    isOpen={ $isConfirmationModalOpen }
    onConfirm={ finalizeNavigation }
    onCancel={ toggleConfirmModal }
    confirmationText={ 'You have unsaved information, are you sure you wanna leave?' }
/>

<AdminPage
    pageTitle="space-label"
    selectedObject={ selectedSpaceStore }
    objectArrayStore={ spaceArrayStore }
    isObjectModalOpen={ isSpaceModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap  }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadSpaceArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ () => handleCreateSpace( arrayProcessing ) }
    handleEditObject={ () => handleEditSpace( arrayProcessing ) }
    handleDeleteObject={ () => handleDeleteSpace( arrayProcessing ) }
    toggleObjectModal={ toggleSpaceModal }
    showButton={ hasUserPermission( 'add-space' ) }
    isFormModified={ $isSpaceFormModified }
    handleNearBottom={ handleNearBottom }
    isCustomTable
    objectConfigMap={ tableConfigMap }
    isSubmitting={ $isSubmitting }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Name</span>
            <InputLocalizedForm
                name='name'
                itemsString={ $selectedSpaceStore.name }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateSpaceLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Description</span>
            <InputLocalizedForm
                name='description'
                itemsString={ $selectedSpaceStore.description }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateSpaceLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Floor</span>
            <Input
                type="number"
                bind:value={ $selectedSpaceStore.floorNumber }
                fullWidth
                name="floorNumber"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Area</span>
            <Input
                type="number"
                bind:value={ $selectedSpaceStore.area }
                fullWidth
                name="area"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">mÂ²</span>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Type</span>
            <Select fullWidth name="countryCode" bind:value={ $selectedSpaceStore.typeId }>
                {#each $spaceTypeArrayStore as spaceType }
                    <option value={ spaceType.id }>{ getLocalizedText( spaceType.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width: 100%;">
                <PropertySelect
                    bind:property={ $selectedSpaceStore.property }
                    bind:propertyId={ $selectedSpaceStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Owner</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedSpaceStore.userProfile }
                    bind:userId={ $selectedSpaceStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>
    </form>
</AdminPage>
