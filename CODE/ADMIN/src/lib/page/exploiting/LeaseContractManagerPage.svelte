<script>
    // -- IMPORTS

    import { formatDate, getFormattedPrice, getCurrencySymbol } from '$lib/base';
    import { getLocalizedText } from 'senselogic-gist';
    import { getOptionArray } from '$lib/base';
    import { languageTagStore } from '$store/languageTagStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import
    {
        handleCreateLeaseContract,
        handleDeleteLeaseContract,
        handleEditLeaseContract,
        isLeaseContractModalOpen,
        loadLeaseContractArray,
        profileArrayStore,
        propertyArrayStore,
        leaseContractArrayStore,
        selectedLeaseContractStore,
        toggleLeaseContractModal,
        leaseStatusArrayStore,
        isFormModified as isLeaseContractFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        hasMorePage,
        isLeaseContractLoading
    }
    from '$store/leaseContractStore';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import Switch from 'senselogic-flow/Switch.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import Select from '$component/element/Select.svelte';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import { currencyArrayStore } from '$store/currencyArrayStore';

    // -- CONSTANTS

    const filterParameterByKeyMap =
    {
        id :
        {
            type : 'text',
            name : 'ID',
            value : ''
        },
        tenant :
        {
            type : 'text',
            name : 'Tenant',
            value : ''
        },
        lessor :
        {
            type : 'text',
            name : 'Lessor',
            value : ''
        },
        statusName :
        {
            type : 'select',
            name : 'Status',
            value : '',
            optionArray : [],
        },
        propertyTitle :
        {
            type : 'text',
            name : 'Property',
            value : ''
        },
        formattedStartingDate :
        {
            type : 'date',
            name : 'Starting Date',
            value : new Date().toISOString()
        },
        formattedEndingDate :
        {
            type : 'date',
            name : 'Ending Date',
            value : new Date().toISOString()
        },
        formattedMonthlyRent :
        {
            type : 'number',
            name : 'Monthly rent',
            value : 0
        },
        monthlyFee :
        {
            type : 'number',
            name : 'Monthly fee',
            value : 0
        },
        formattedGuaranteeAmount :
        {
            type : 'number',
            name : 'Guarantee',
            value : 0
        },
        yearlyTax :
        {
            type : 'number',
            name : 'Yearly tax',
            value : 0
        },
        agencyFee :
        {
            type : 'number',
            name : 'Agency fee',
            value : 0
        },
        lessorNoticePeriod :
        {
            type : 'text',
            name : 'Lessor notice period',
            value : ''
        },
        tenatNoticePeriod :
        {
            type : 'text',
            name : 'Tenant notice period',
            value : ''
        },
        adultCount :
        {
            type : 'number',
            name : 'Adults',
            value : 0
        },
        childrenCount :
        {
            type : 'number',
            name : 'Children',
            value : 0
        },
        infantCount :
        {
            type : 'number',
            name : 'Infants',
            value : 0
        },
        hasBankGuarantee :
        {
            type : 'boolean',
            name : 'Bank guarantee',
            value : false
        },
        requiresRepaint :
        {
            type : 'boolean',
            name : 'Requires repaint',
            value : false
        },
        hasPet :
        {
            type : 'boolean',
            name : 'Has pets',
            value : false
        }
    };
    const titleSlugMap =
    {
        editTitle : 'edit-lease-contract-label',
        addTitle : 'add-lease-contract-label'
    };

    // -- VARIABLES

    let filterableColumnByColumnNameMap =
    $state({
        id: { columnLabel: 'Contract ID', type: 'text' },
        propertyId: { columnLabel: 'Property ID', type: 'text' },
        startingDate: { columnLabel: 'Start Date', type: 'text' },
        endingDate: { columnLabel: 'End Date', type: 'text' },
        lessorUserProfileId: { columnLabel: 'Lessor Profile ID', type: 'text' },
        lessorNoticePeriod: { columnLabel: 'Lessor Notice Period', type: 'text' },
        tenantUserProfileId: { columnLabel: 'Tenant Profile ID', type: 'text' },
        tenantNoticePeriod: { columnLabel: 'Tenant Notice Period', type: 'text' },
        status: { columnLabel: 'Contract Status', type: 'select', optionArray: [] },
        adultCount: { columnLabel: 'Adults', type: 'text' },
        childrenCount: { columnLabel: 'Children', type: 'text' },
        infantCount: { columnLabel: 'Infants', type: 'text' },
        hasPet: { columnLabel: 'Has Pet', type: 'boolean' },
        hasBankGuarantee: { columnLabel: 'Has Bank Guarantee', type: 'boolean' },
        requiresRepaint: { columnLabel: 'Requires Repaint', type: 'boolean' },
        monthlyRent: { columnLabel: 'Monthly Rent', type: 'text' },
        monthlyFee: { columnLabel: 'Monthly Fee', type: 'text' },
        yearlyTax: { columnLabel: 'Yearly Tax', type: 'text' },
        agencyFee: { columnLabel: 'Agency Fee', type: 'text' },
        guaranteeAmount: { columnLabel: 'Guarantee Amount', type: 'text' },
        currencyCode: { columnLabel: 'Currency Code', type: 'text' },
        description: { columnLabel: 'Description', type: 'text' },
        userId: { columnLabel: 'User ID', type: 'text' },
        creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
        updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
    });

    let selectedLeaseContractIndex = null;
    let searchTerm = '';
    let searchColumn = '';

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.status.optionArray = getOptionArray( $leaseStatusArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePage && !$isLeaseContractLoading )
        {
            await loadLeaseContractArray( page );
        }
    }
</script>

<AdminPage
    pageTitle="admin-menu-lease-contracts-manager-label"
    selectedObject={ selectedLeaseContractStore }
    objectArrayStore={ leaseContractArrayStore }
    isObjectModalOpen={ isLeaseContractModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadLeaseContractArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateLeaseContract }
    handleEditObject={ handleEditLeaseContract }
    handleDeleteObject={ handleDeleteLeaseContract }
    toggleObjectModal={ toggleLeaseContractModal }
    isFormModified={ $isLeaseContractFormModified }
    showButton={ hasUserPermission( 'add-lease-contract' ) }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseContractStore.id }
                fullWidth
                name="text"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Tenant</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedLeaseContractStore.tenantProfile }
                    bind:userId={ $selectedLeaseContractStore.tenantUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Lessor</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedLeaseContractStore.lessorProfile }
                    bind:userId={ $selectedLeaseContractStore.lessorUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Status</span>
            <Select fullWidth name="cityCode" bind:value={ $selectedLeaseContractStore.status }>
                {#each $leaseStatusArrayStore as leaseStatus }
                    <option value={ leaseStatus.id }>{ getLocalizedText( leaseStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width:100%;">
                <PropertySelect
                    bind:property={ $selectedLeaseContractStore.property }
                    bind:propertyId={ $selectedLeaseContractStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row inline">
            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Starting date</span>
                <Input
                    type="date"
                    bind:value={ $selectedLeaseContractStore.startingDate }
                    fullWidth
                    name="startingDate"
                />
            </div>

            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Ending date</span>
                <Input
                    type="date"
                    bind:value={ $selectedLeaseContractStore.endingDate }
                    fullWidth
                    name="endingDate"
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Currency</span>
            <Select fullWidth name="currencyCode" bind:value={ $selectedLeaseContractStore.currencyCode }>
                {#each $currencyArrayStore as currencyArray }
                    <option value={ currencyArray.code }>{ getLocalizedText( currencyArray.singularName, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row inline">
            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Monthly rent</span>
                <Input
                    type="number"
                    bind:value={ $selectedLeaseContractStore.monthlyRent }
                    fullWidth
                    name="monthlyRent"
                >
                    <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseContractStore.currencyCode ) || '💲' }</span>
                </Input>
            </div>

            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Monthly fee</span>
                <Input
                    type="number"
                    bind:value={ $selectedLeaseContractStore.monthlyFee }
                    fullWidth
                    name="monthlyFee"
                >
                    <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseContractStore.currencyCode ) || '💲' }</span>
                </Input>
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Guarantee</span>
            <Input
                type="number"
                bind:value={ $selectedLeaseContractStore.guaranteeAmount }
                fullWidth
                name="guaranteeAmount"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseContractStore.currencyCode ) || '💲' }</span>
            </Input>
        </div>

        <div class="input-row inline">
            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Yearly tax</span>
                <Input
                    type="number"
                    bind:value={ $selectedLeaseContractStore.yearlyTax }
                    fullWidth
                    name="yearlyTax"
                >
                    <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseContractStore.currencyCode ) || '💲' }</span>
                </Input>
            </div>

            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Agency fee</span>
                <Input
                    type="number"
                    bind:value={ $selectedLeaseContractStore.agencyFee }
                    fullWidth
                    name="agencyFee"
                >
                    <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseContractStore.currencyCode ) || '💲' }</span>
                </Input>
            </div>
        </div>

        <div class="input-row inline">
            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Lessor notice period</span>
                <Input
                    type="date"
                    bind:value={ $selectedLeaseContractStore.lessorNoticePeriod }
                    fullWidth
                    name="lessorNoticePeriod"
                />
            </div>

            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Tenant notice period</span>
                <Input
                    type="date"
                    bind:value={ $selectedLeaseContractStore.tenantNoticePeriod }
                    fullWidth
                    name="tenantNoticePeriod"
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Adults</span>
            <Input
                type="number"
                bind:value={ $selectedLeaseContractStore.adultCount }
                fullWidth
                name="adultCount"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Children</span>
            <Input
                type="number"
                bind:value={ $selectedLeaseContractStore.childrenCount }
                fullWidth
                name="childrenCount"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Infants</span>
            <Input
                type="number"
                bind:value={ $selectedLeaseContractStore.infantCount }
                fullWidth
                name="infantCount"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedLeaseContractStore.userProfile }
                    bind:userId={ $selectedLeaseContractStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Description</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseContractStore.description }
                fullWidth
                name="text"
                multiline
                rows="5"
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Bank guarantee</span>
            <Switch
                bind:value={ $selectedLeaseContractStore.hasBankGuarantee }
                onChange={ handleChange }
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Requires repaint</span>
            <Switch
                bind:value={ $selectedLeaseContractStore.requiresRepaint }
                onChange={ handleChange }
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Has pets</span>
            <Switch
                bind:value={ $selectedLeaseContractStore.hasPet }
                onChange={ handleChange }
            />
        </div>
    </form>
</AdminPage>
