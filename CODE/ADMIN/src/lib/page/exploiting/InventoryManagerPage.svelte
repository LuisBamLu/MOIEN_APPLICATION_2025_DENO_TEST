<script>
    // -- IMPORTS

    import { formatDate, getOptionArray } from '$lib/base';
    import
    {
        inventoryArrayStore,
        isInventoryModalOpen,
        toggleInventoryModal,
        selectedInventoryStore,
        loadInventoryArray,
        handleCreateInventory,
        handleEditInventory,
        handleDeleteInventory,
        isFormModified as isInventoryFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        profileArrayStore,
        propertyArrayStore,
        documentArrayStore,
        hasMorePage,
        isInventoryLoading
    }
    from '$store/inventoryStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import { getLocalizedText } from 'senselogic-gist';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import Svelecte from 'svelecte';
    import { languageTagStore } from '$store/languageTagStore';

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        id :
            {
                name : 'ID',
                type : 'text',
                value : ''
            },
        propertyName :
            {
                name : 'Property name',
                type : 'text',
                value : ''
            },
        date :
            {
                name : 'Date',
                type : 'text',
                value : ''
            },
        name :
            {
                name : 'Name',
                type : 'text',
                value : ''
            },
        lessorUserProfileName :
            {
                name : 'Lessor name',
                type : 'text',
                value : ''
            },
        tenantUserProfileName :
            {
                name : 'Tenant name',
                type : 'text',
                value : ''
            },
        keyCount :
            {
                name : 'Key count',
                type : 'number',
                value : ''
            },
        description :
            {
                name : 'Description',
                type : 'text',
                value : ''
            },
        document :
            {
                name : 'Documents',
                type : 'text',
                value : ''
            },
        userName :
            {
                name : 'User name',
                type : 'text',
                value : ''
            }
    };
    let filterableColumnByColumnNameMap =
    {
        id: { columnLabel: 'Inventory ID', type: 'text' },
        propertyId: { columnLabel: 'Property ID', type: 'text' },
        date: { columnLabel: 'Date', type: 'text' },
        name: { columnLabel: 'Name', type: 'text' },
        lessorUserProfileId: { columnLabel: 'Lessor User Profile ID', type: 'profile' },
        tenantUserProfileId: { columnLabel: 'Tenant User Profile ID', type: 'profile' },
        keyCount: { columnLabel: 'Number of Keys', type: 'text' },
        description: { columnLabel: 'Description', type: 'text' },
        userId: { columnLabel: 'User ID', type: 'profile' },
        creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
        updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
    };

    let titleSlugMap =
    {
        editTitle: 'edit-inventory-label',
        addTitle: 'add-inventory-label'
    };

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        inventoryArrayStore.update(
            inventoryArray => inventoryArray.map(
                inventory =>
                {
                        let userProfile = $profileArrayStore.find( profile => profile.userId === inventory.userId );
                        let lessorProfile = $profileArrayStore.find( profile => profile.userId === inventory.lessorUserProfileId );
                        let tenantProfile = $profileArrayStore.find( profile => profile.userId === inventory.tenantUserProfileId );
                        let property = $propertyArrayStore.find( property => property.id === inventory.propertyId );
                        let documentArray = $documentArrayStore.filter( document => inventory.documentIdArray.includes( document.id ) );

                        return (
                            {
                                ...inventory,
                                userProfile,
                                lessorProfile,
                                tenantProfile,
                                property,
                                documentArray,
                                propertyName: property?.title ?? '',
                                lessorUserProfileName: [ lessorProfile?.firstName, lessorProfile?.lastName ].join( ' ' ),
                                tenantUserProfileName: [ tenantProfile?.firstName, tenantProfile?.lastName ].join( ' ' ),
                                userName: [ userProfile?.firstName, userProfile?.lastName ].join( ' ' ),
                                document: documentArray.map( document => document.name ).join( ', ' )
                            }
                            );
                    }
                )
            );
        // filterParameterByKeyMap.inventoryType.optionArray = getOptionArray( $inventoryTypeArrayStore );
    }

    // ~~

    function handleUpdateInventoryLocalizedInput(
        event
        )
    {
        handleChange();
        selectedInventoryStore.update( ( inventory ) => ( { ...inventory, name: event.detail.text } ) );
    }
</script>

<AdminPage
    pageTitle="admin-menu-inventories-manager-label"
    selectedObject={ selectedInventoryStore }
    objectArrayStore={ inventoryArrayStore }
    isObjectModalOpen={ isInventoryModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadInventoryArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateInventory }
    handleEditObject={ handleEditInventory }
    handleDeleteObject={ handleDeleteInventory }
    toggleObjectModal={ toggleInventoryModal }
    showButton={ hasUserPermission( 'add-inventory' ) }
    isFormModified={ $isInventoryFormModified }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedInventoryStore.id }
                fullWidth
                name="id"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width: 100%;">
                <PropertySelect
                    bind:property={ $selectedInventoryStore.property }
                    bind:propertyId={ $selectedInventoryStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Name</span>
            <InputLocalizedForm
                name='name'
                itemsString={ $selectedInventoryStore.name }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateInventoryLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Description</span>
            <InputLocalizedForm
                name='description'
                itemsString={ $selectedInventoryStore.description }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateInventoryLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Date</span>
            <Input
                type="date"
                bind:value={ $selectedInventoryStore.date }
                fullWidth
                name="date"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Lessor user</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedInventoryStore.lessorProfile }
                    bind:userId={ $selectedInventoryStore.lessorUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Tenant user</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedInventoryStore.tenantProfile }
                    bind:userId={ $selectedInventoryStore.tenantUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedInventoryStore.userProfile }
                    bind:userId={ $selectedInventoryStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Key count</span>
            <Input
                type="number"
                bind:value={ $selectedInventoryStore.keyCount }
                fullWidth
                name="keyCount"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Documents</span>
            <div style="width: 100%;">
                <Svelecte
                    required
                    name="documentIdArray"
                    multiple
                    options={
                                $documentArrayStore.map(
                                    ( document ) =>
                                        (
                                            {
                                                ...document,
                                                name: getLocalizedText( document?.name || '', $languageTagStore )
                                            }
                                        )
                                    )
                            }
                    bind:value={ $selectedInventoryStore.documentIdArray }
                    on:change={ handleChange }
                />
            </div>
        </div>
    </form>
</AdminPage>
