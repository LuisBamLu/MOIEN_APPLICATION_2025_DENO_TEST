<script>
    // -- IMPORTS

    import { getJsonText, getLocalizedText, isArray } from 'senselogic-gist';
    import { getOptionArray, getFormattedPrice, fetchData, isDefinedAndNotNull, isNullOrUndefined } from '$lib/base';
    import { languageTagStore } from '$store/languageTagStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import
    {
        handleCreateRentalBooking,
        handleDeleteRentalBooking,
        handleEditRentalBooking,
        isRentalBookingModalOpen,
        loadRentalBookingArray,
        profileArrayStore,
        propertyArrayStore,
        rentalBookingArrayStore,
        selectedRentalBookingStore,
        toggleRentalBookingModal,
        isFormModified as isRentalBookingFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        rentalBookingStatusArrayStore,
        cancellationPolicyArrayStore,
        isRentalBookingLoading,
        hasMorePageStore
    }
    from '$store/rentalBookingStore';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import Select from '$component/element/Select.svelte';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import Switch from 'senselogic-flow/Switch.svelte';
    import ActionButton from '$component/element/ActionButton.svelte';
    import { toast } from '$lib/toast';
    import AdminCardList from '$component/element/AdminCardList/AdminCardList.svelte';
    import AdminModal from '$lib/component/element/AdminModal.svelte';

    // -- CONSTANTS

    const filterParameterByKeyMap =
    {
        id :
        {
            type: 'text',
            name: 'ID',
            value: '',
        },
        userName :
        {
            type: 'text',
            name: 'User',
            value: '',
        },
        statusName :
        {
            type: 'select',
            name: 'Status',
            value: '',
            optionArray: [],
        },
        propertyTitle :
        {
            type: 'text',
            name: 'Property',
            value: '',
        },
        donation :
        {
            type: 'text',
            name: 'Donation',
            value: '',
        },
        guestCount :
        {
            type: 'text',
            name: 'Guest Count',
            value: '',
        },
        formattedTotalPrice :
        {
            type: 'text',
            name: 'Total',
            value: '',
        },
        arrivalDate :
        {
            type: 'text',
            name: 'Arrival Date',
            value: '',
        },
        arrivalTime :
        {
            type: 'text',
            name: 'Arrival Time',
            value: '',
        },
        departureDate :
        {
            type: 'text',
            name: 'Departure Date',
            value: '',
        },
        departureTime :
        {
            type: 'text',
            name: 'Departure Time',
            value: '',
        },
        dayCount :
        {
            type: 'text',
            name: 'Day Count',
            value: '',
        }
    };
    const titleSlugMap =
    {
        editTitle: 'edit-rental-booking-label',
        addTitle: 'add-rental-booking-label'
    };

    // -- VARIABLES

    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'Reservation ID', type: 'text' },
            propertyId: { columnLabel: 'Property ID', type: 'text' },
            guestCount: { columnLabel: 'Guest Count', type: 'text' },
            arrivalDate: { columnLabel: 'Arrival Date', type: 'text' },
            arrivalTime: { columnLabel: 'Arrival Time', type: 'text' },
            departureDate: { columnLabel: 'Departure Date', type: 'text' },
            departureTime: { columnLabel: 'Departure Time', type: 'text' },
            dayCount: { columnLabel: 'Day Count', type: 'text' },
            cleaningFee: { columnLabel: 'Cleaning Fee', type: 'text' },
            sheetsFee: { columnLabel: 'Sheets Fee', type: 'text' },
            towelsFee: { columnLabel: 'Towels Fee', type: 'text' },
            otherFee: { columnLabel: 'Other Fee', type: 'text' },
            donation: { columnLabel: 'Donation', type: 'text' },
            carbonCompensationDonation: { columnLabel: 'Carbon Compensation Donation', type: 'text' },
            totalPrice: { columnLabel: 'Total Price', type: 'text' },
            cancellationPolicyId: { columnLabel: 'Cancellation Policy', type: 'select', optionArray: [] },
            isNonRefundable: { columnLabel: 'Non-Refundable', type: 'boolean' },
            status: { columnLabel: 'Reservation Status', type: 'select', optionArray: [] },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'text' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'text' }
        });
    let selectedRentalBookingIndex = null;
    let searchTerm = '';
    let searchColumn = '';
    let isSubmitting = $state(false);
    let isLoadingTicketArray = $state(false);
    let selectedTicketId = $state(null);

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.cancellationPolicyId.optionArray = getOptionArray( $cancellationPolicyArrayStore );
        filterableColumnByColumnNameMap.status.optionArray = getOptionArray( $rentalBookingStatusArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isRentalBookingLoading && $hasMorePageStore )
        {
            await loadRentalBookingArray( page );
            arrayProcessing();
        }
    }

    // ~~

    function shouldShowCancelButton(
        )
    {
        return [ 'paid', 'confirmed', 'requested' ].includes( $selectedRentalBookingStore.status );
    }

    // ~~

    async function handleCancelRentalBooking(
        rentalBookingId
        )
    {
        isSubmitting = true;

        try
        {
            if ( isNullOrUndefined( selectedTicketId ) )
            {
                toast.error( 'No tickets related to this rental booking.' );

                return;
            }

            let response = await fetchData(
                '/api/admin/page/rental-booking/' + $selectedRentalBookingStore.id + '/refund',
                { method: 'POST', credentials: 'include', body: getJsonText( { ticketId: selectedTicketId } ) }
                );

            selectedRentalBookingStore.set(
                {
                    ...$selectedRentalBookingStore,
                    ...response.rentalBooking
                }
                );

            toast.success( 'Rental booking refunded' );
            toggleRentalBookingModal();
        }
        catch ( error )
        {
            toast.error( error.message );
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // ~~

    async function getRelatedTicketArray(
        )
    {
        isLoadingTicketArray = true;

        let response = await fetchData(
            '/api/admin/page/rental-booking/' + $selectedRentalBookingStore.id + '/tickets',
            { method: 'POST', credentials: 'include', body: getJsonText( {} ) }
            );

        isLoadingTicketArray = false;

        return response;
    }
</script>

<style lang="stylus">
    // -- CLASSES

    .status-select-container
    {
        width: 100%;

        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
</style>

<AdminPage
    pageTitle="admin-menu-rental-bookings-manager-label"
    selectedObject={ selectedRentalBookingStore }
    objectArrayStore={ rentalBookingArrayStore }
    isObjectModalOpen={ isRentalBookingModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadRentalBookingArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateRentalBooking }
    handleEditObject={ handleEditRentalBooking }
    handleDeleteObject={ handleDeleteRentalBooking }
    toggleObjectModal={ toggleRentalBookingModal }
    showButton={ hasUserPermission( 'add-rental-booking' ) }
    isFormModified={ $isRentalBookingFormModified }
    handleNearBottom={ handleNearBottom }
>
    {#snippet modal()}

            {@const isEditing = isDefinedAndNotNull( $selectedRentalBookingStore?.id )}
            <AdminModal
                isObjectModalOpen={ $isRentalBookingModalOpen }
                toggleObjectModal={ toggleRentalBookingModal }
                isEditing={ isEditing }
                handleCreate={ () => handleCreateRentalBooking( arrayProcessing ) }
                handleEdit={ () => handleEditRentalBooking( arrayProcessing ) }
                handleDelete={ () => handleDeleteRentalBooking( arrayProcessing ) }
                isDeleteButtonDisabled={ true }
                titleSlugMap={ titleSlugMap }
                showModalButton={ hasUserPermission( 'add-rental-booking' ) }
                disabled={ !$isRentalBookingFormModified }
                isSubmitting={ isSubmitting }
            >
                <form onchange={handleChange} class="edit-modal-form">
                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
                        <Input
                            type="text"
                            bind:value={ $selectedRentalBookingStore.id }
                            fullWidth
                            name="text"
                            readonly
                        />
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">User</span>
                        <div style="width:100%;">
                            <UserSelect
                                bind:profile={ $selectedRentalBookingStore.profile }
                                bind:userId={ $selectedRentalBookingStore.userId }
                                on:change={ handleChange }
                                profileArray={ $profileArrayStore }
                            />
                        </div>
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">Status</span>
                        <div class="status-select-container">
                            <Select disabled fullWidth name="status" bind:value={ $selectedRentalBookingStore.status }>
                                {#each $rentalBookingStatusArrayStore as rentalBookingStatus }
                                    <option value={ rentalBookingStatus.id }>{ getLocalizedText( rentalBookingStatus.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                            {#if shouldShowCancelButton() }
                                <ActionButton
                                    on:click={ handleCancelRentalBooking }
                                    variant="decline"
                                    isLoading={ isSubmitting || isLoadingTicketArray }
                                    disabled={ !selectedTicketId }
                                >
                                    Cancel booking
                                </ActionButton>
                            {/if}
                        </div>
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">Tickets</span>
                        {#await getRelatedTicketArray()}
                            Loading...
                        {:then response}
                            {#if response.ticketArray && isArray( response.ticketArray ) }
                                <Select fullWidth name="cancellationPolicyId" bind:value={ selectedTicketId }>
                                    {#each response.ticketArray as ticket}
                                        <option value={ ticket.id } disabled={ ticket.statusId === 'cancelled' || ticket.statusId === 'resolved' }>
                                            { getLocalizedText( ticket.ticketStatus.name, $languageTagStore ) } - { ticket.title }
                                        </option>
                                    {/each}
                                </Select>
                            {/if}
                        {:catch}
                            Something went wrong
                        {/await}
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
                        <div style="width:100%;">
                            <PropertySelect
                                bind:property={ $selectedRentalBookingStore.property }
                                bind:propertyId={ $selectedRentalBookingStore.propertyId }
                                on:change={ handleChange }
                                propertyArray={ $propertyArrayStore }
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Donation</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.donation }
                                fullWidth
                                name="donation"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Guest count</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.guestCount }
                                fullWidth
                                name="guestCount"
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Day count</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.dayCount }
                                fullWidth
                                name="dayCount"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Total price</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.totalPrice }
                                fullWidth
                                name="totalPrice"
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Arrival date</span>
                            <Input
                                type="date"
                                bind:value={ $selectedRentalBookingStore.arrivalDate }
                                fullWidth
                                name="arrivalDate"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Arrival time</span>
                            <Input
                                type="time"
                                bind:value={ $selectedRentalBookingStore.arrivalTime }
                                fullWidth
                                name="arrivalTime"
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Departure date</span>
                            <Input
                                type="date"
                                bind:value={ $selectedRentalBookingStore.departureDate }
                                fullWidth
                                name="departureDate"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Departure time</span>
                            <Input
                                type="time"
                                bind:value={ $selectedRentalBookingStore.departureTime }
                                fullWidth
                                name="departureTime"
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Cleaning fee</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.cleaningFee }
                                fullWidth
                                name="cleaningFee"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Towels fee</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.towelsFee }
                                fullWidth
                                name="towelsFee"
                            />
                        </div>
                    </div>

                    <div class="input-row inline">
                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Other fee</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.otherFee }
                                fullWidth
                                name="otherFee"
                            />
                        </div>

                        <div class="input-row flex-grow">
                            <span class="font-weight-700 line-height-150 color-gray-100">Sheets fee</span>
                            <Input
                                type="number"
                                bind:value={ $selectedRentalBookingStore.sheetsFee }
                                fullWidth
                                name="sheetsFee"
                            />
                        </div>
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">Carbon compensation donation</span>
                        <Input
                            type="number"
                            bind:value={ $selectedRentalBookingStore.carbonCompensationDonation }
                            fullWidth
                            name="carbonCompensationDonation"
                        />
                    </div>

                    <div class="input-row">
                        <span class="font-weight-700 line-height-150 color-gray-100">Cancellation policy</span>
                        <Select fullWidth name="cancellationPolicyId" bind:value={ $selectedRentalBookingStore.cancellationPolicyId }>
                            {#each $cancellationPolicyArrayStore as cancellationPolicy }
                                <option value={ cancellationPolicy.id }>{ getLocalizedText( cancellationPolicy.name, $languageTagStore ) }</option>
                            {/each}
                        </Select>
                    </div>

                    <div class="input-row space-between inline">
                        <span class="font-weight-700 line-height-150 color-gray-100">Is non refundable</span>
                        <Switch
                            bind:value={ $selectedRentalBookingStore.isNonRefundable }
                            onChange={ handleChange }
                        />
                    </div>
                </form>
            </AdminModal>

    {/snippet}
</AdminPage>
