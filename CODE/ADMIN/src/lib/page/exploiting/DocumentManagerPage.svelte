<script>
    // -- IMPORTS

    import
    {
        documentArrayStore,
        handleCreateDocument,
        hasMorePage,
        isDocumentLoading,
        isDocumentModalOpen,
        languageArrayStore,
        loadDocumentArray,
        profileArrayStore,
        selectedDocumentStore,
        toggleDocumentModal,
        validationStatusArrayStore,
        documentTypeArrayStore
    }
    from '$store/documentStore';
    import { navigate } from 'svelte5-router';
    import { toast } from '$lib/toast';
    import { fetchData, formatDate, getOptionArray } from '$lib/base';
    import { getLocalizedText, getLocalizedTextBySlug } from 'senselogic-gist';
    import { languageTagStore } from '$store/languageTagStore';
    import AdminModal from '$component/element/AdminModal.svelte';
    import AdminPage from '$component/element/AdminPage.svelte';
    import EditRowComponent from '$component/element/EditRowComponent.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import { getStorageImagePath } from '$src/lib/storage';

    // -- CONSTANTS

    const titleSlugMap =
        {
            editTitle: 'document-label',
            addTitle: 'add-document-label'
        };

    // -- VARIABLES

    let filterParameterByKeyMap =
        {
            name:
            {
                type: 'text',
                name: 'Document name',
                value: ''
            },
            userName:
            {
                type: 'text',
                name: 'Owner',
                value: ''
            },
            localization:
            {
                type: 'select',
                name: 'Localization',
                optionArray: [],
                value: ''
            },
            status:
            {
                type: 'select',
                name: 'Status',
                optionArray: [],
                value: ''
            },
            creationDate:
            {
                type: 'timestamp',
                name: 'Creation date',
                value: ''
            },
            updateDate:
            {
                type: 'timestamp',
                name: 'Update date',
                value: ''
            },
            filePath:
            {
                name: '',
            }
        };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'Document ID', type: 'text' },
            typeId: { columnLabel: 'Document Type', type: 'select', optionArray: [] },
            validationStatusId: { columnLabel: 'Validation Status', type: 'select', optionArray: [] },
            expirationDate: { columnLabel: 'Expiration Date', type: 'text' },
            name: { columnLabel: 'Document Name', type: 'text' },
            description: { columnLabel: 'Description', type: 'text' },
            languageTag: { columnLabel: 'Language', type: 'text' },
            countryIdArray: { columnLabel: 'Countries (ID List)', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            mangopayDocumentId: { columnLabel: 'Mangopay Document ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'text' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'text' }
        });

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.typeId.optionArray = getOptionArray( $documentTypeArrayStore );
        filterableColumnByColumnNameMap.validationStatusId.optionArray = getOptionArray( $validationStatusArrayStore );
    }

    // ~~

    async function handleDelete(
        documentId
        )
    {
        try
        {
            let formData = new FormData();

            formData.append( 'type', 'deleteDocument' );
            formData.append( 'documentId', documentId );

            let response = await fetchData( '/api/document/delete/' + documentId, { method: 'POST', body: formData, credentials: 'include' } );

            toast.success( getLocalizedTextBySlug( response.message, $languageTagStore ) );

            documentArrayStore.update(
                ( documentArray ) => documentArray.filter( ( document ) => document.id !== documentId )
                );
        }
        catch ( error )
        {
            toast.error( getLocalizedTextBySlug( error.error, $languageTagStore ) );
        }
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isDocumentLoading && $hasMorePage )
        {
            await loadDocumentArray( page );
        }
    }
    let objectConfigMap =
        $derived({
            headerArray :
                [
                    { type : 'text', label : 'Document name', key : 'name' },
                    { type : 'text', label : 'Owner', key : 'userName' },
                    { type : 'text', label : 'Localization', key : 'localization' },
                    { type : 'text', label : 'Status', key : 'status' },
                    { type : 'text', label : 'Creation date', key : 'creationDate' },
                    { type : 'text', label : 'Update date', key : 'updateDate' },
                    { type : 'element', label : '', key : 'edit' },
                ],
            dataArray :
                $documentArrayStore.map(
                    ( document ) =>
                    {
                        let profile = $profileArrayStore.find( ( user ) => user.userId === document.userId );
                        let language = $languageArrayStore.find( ( language ) => language.tag === document.languageTag );
                        let status = $validationStatusArrayStore.find( ( validationStatus ) => validationStatus.id === document.validationStatusId );
                        let countryCode = document.countryIdArray?.[ 0 ];
                        let creationDate = formatDate( document.creationTimestamp, { dateStyle : 'short', timeStyle: 'short' } );
                        let updateDate = formatDate( document.updateTimestamp, { dateStyle : 'short', timeStyle: 'short' } );
                        let localization = [ language?.tag, countryCode ].join( '-' );

                        return (
                            {
                                ...document,
                                userName : `${ profile?.firstName ?? '' } ${ profile?.lastName ?? '' }`,
                                localization,
                                status : getLocalizedText( status?.name, $languageTagStore ),
                                creationDate,
                                updateDate,
                                edit :
                                    {
                                        component : EditRowComponent,
                                        propMap :
                                            {
                                                onEdit : ( event ) =>
                                                    {
                                                        event.stopPropagation();
                                                        selectedDocumentStore.set( document );
                                                        navigate( '/admin/edit-view/documents/' + document.id );
                                                    },
                                                onDelete : ( event ) => { event.stopPropagation(); handleDelete( document.id ) },
                                                isShownEditing : hasUserPermission( 'set-document' ),
                                                isShownDelete : hasUserPermission( 'remove-document' )
                                            }
                                    }
                            }
                            );
                    }
                ) || []
        });
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- STYLES

    .document-image
    {
        max-height: 35rem;
        width: 100%;

        object-fit: contain;
    }
</style>
<AdminPage
    pageTitle="admin-menu-documents-manager-label"
    selectedObject={ selectedDocumentStore }
    objectArrayStore={ documentArrayStore }
    isObjectModalOpen={ isDocumentModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadDocumentArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateDocument }
    handleEditObject={ ( object ) => { selectedDocumentStore.set( object ); toggleDocumentModal(); } }
    handleDeleteObject={ () => {} }
    toggleObjectModal={ toggleDocumentModal }
    handleNearBottom={ handleNearBottom }
    showButton={ false }
    showModalButton={ false }
    isCustomTable
    objectConfigMap={ objectConfigMap }
>
    <AdminModal
        isObjectModalOpen={ $isDocumentModalOpen }
        toggleObjectModal={ toggleDocumentModal }
        isEditing
        handleCreate={ () => {} }
        handleEdit={ () => {} }
        handleDelete={ () => {} }
        titleSlugMap={ titleSlugMap }
        showModalButton={ false }
    >
        <img
            src={ getStorageImagePath( $selectedDocumentStore.filePath, 1920 ) }
            alt={ $selectedDocumentStore.name }
            class="document-image"
        />
    </AdminModal>
</AdminPage>
