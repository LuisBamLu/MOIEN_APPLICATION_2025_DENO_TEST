<script>
    // -- IMPORTS

    import { fetchData, getFilterParameterByKeyMap } from '$lib/base';
    import { getLocalizedTextBySlug } from 'senselogic-gist';
    import { onMount } from 'svelte';
    import Sidebar from '$component/layout/Sidebar.svelte';
    import { urlParamsStore } from '$store/urlParamsStore';
    import PageTitle from '$component/element/PageTitle.svelte';
    import Loading from '$component/element/Loading.svelte';
    import MessageTable from '$component/page/message/MessageTable.svelte';
    import ConversationContainer from '$component/page/message/ConversationContainer.svelte';

    // -- VARIABLES

    let conversationArray = $state([]);
    let isLoading = $state(true);
    let indexAccordionOpen = null;
    let message =
        {
            sourceUserProfileId : '',
            updateTimestamp : Date.now(),
            message : '',
            creationTimestamp : Date.now()
        };
    let filterParameterByKeyMap =
        $state({
            type:
            {
                type: 'select',
                name: 'Type',
                optionArray: [],
                value: ''
            },
            sourceUserProfile:
            {
                type: 'profile',
                name: 'Source user',
                value: ''
            },
            targetUserProfile:
            {
                type: 'profile',
                name: 'Target user',
                value: ''
            },
            property:
            {
                type: 'property',
                name: 'Property',
                value: ''
            },
            lastMessage:
            {
                type: 'text',
                name: 'Last message',
                value: ''
            }
        });
    let selectedConversation = $state(null);

    // -- FUNCTIONS

    function handleBack(
        )
    {
        if ( selectedConversation !== null )
        {
            selectedConversation = null;
            return true;
        }
    }

    // -- STATEMENTS

    onMount(
        async () =>
        {
            let result = await fetchData(
                '/api/admin/page/conversation/get',
                {
                    method: 'POST',
                    body: JSON.stringify(
                        {
                            type: 'getConversationArray'
                        }
                        ),
                    headers: { 'Content-Type': 'application/json' }
                }
                );

            conversationArray = result.conversationArray ?? [];
            filterParameterByKeyMap = getFilterParameterByKeyMap( filterParameterByKeyMap, $urlParamsStore );

            for ( let index = 0; index < conversationArray.length; ++index )
            {
                conversationArray[ index ].lastMessage = conversationArray[ index ].lastMessage ? conversationArray[ index ].lastMessage.text : 'Unknown';
            }

            isLoading = false;
        }
        );
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- ELEMENTS

    main
    {
        padding: 1rem 1.5rem 1rem;

        display: flex;
        flex-direction: column;
        gap: 1rem;

        +media( desktop )
        {
            padding: 3rem 4rem 2rem;
        }
    }

    // -- CLASSES

    .page-container
    {
        min-height: 100dvh;
        padding-top: 7vh;

        display: flex;

        background-color: grayColor900;
    }

    .manager-page
    {
        overflow-x: hidden;
        width: 100%;
        padding-top: 2vh;

        display: flex;
        flex-direction: column;
        gap: 2vh;
    }

    .main-section
    {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cell-container
    {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .cell-avatar
    {
        object-fit: cover;
        object-position: center;
        height: 2rem;
        width: 2rem;
        border-radius: 50%;
    }

    .cell
    {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
</style>

<div class="page-container">
    <Sidebar />
    <div class="manager-page">
        <main>
            <div class="display-flex justify-content-space-between align-items-center">
                <PageTitle
                    title={ selectedConversation ? getLocalizedTextBySlug( 'back-label' ) : getLocalizedTextBySlug( 'messages-label' ) }
                    onBack={ handleBack }
                />
            </div>
            {#if isLoading }
                <Loading />
            {:else}
                {#if selectedConversation === null }
                    <MessageTable
                        conversationArray={ conversationArray }
                        filterParameterByKeyMap={ filterParameterByKeyMap }
                        bind:selectedConversation={ selectedConversation }
                    />
                {:else}
                    <ConversationContainer conversation={ selectedConversation } />
                {/if}
            {/if}
        </main>
    </div>
</div>
