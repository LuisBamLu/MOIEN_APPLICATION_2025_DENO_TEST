<script>
    // -- IMPORTS

    import { getOptionArray } from '$lib/base';
    import { getLocalizedText, isArray } from 'senselogic-gist';
    import { languageTagStore } from '$store/languageTagStore';
    import
    {
        handleCreateUser,
        handleDeleteUser,
        handleEditUser,
        isUserModalOpen,
        loadUserArray,
        hasMorePage,
        selectedUserStore,
        userArrayStore,
        userGenderArray,
        userGenderMap,
        userRoleMap,
        userStatusArray,
        userStatusMap,
        userRoleArray,
        isUserLoading
    } from '$store/userArrayStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import UserInfoCell from '$component/element/UserInfoCell.svelte';
    import Status from '$component/element/Status.svelte';
    import { hasUserPermission } from '$store/profileStore';

    // -- CONSTANTS

    const titleSlugMap =
        {
            editTitle: 'edit-user-label',
            addTitle: 'add-user-label'
        };

    // -- VARIABLES

    let filterParameterByKeyMap =
        {
            userId:
            {
                type: 'text',
                name: 'ID',
                value: ''
            },
            firstName:
            {
                type: 'text',
                name: 'User Name',
                value: ''
            },
            statusId:
            {
                type: 'select',
                name: 'Status',
                optionArray: [],
                value: ''
            },
            genderId:
            {
                type: 'select',
                name: 'Gender',
                optionArray: [],
                value: ''
            },
            phoneNumber:
            {
                type: 'text',
                name: 'Phone',
                value: ''
            }
        };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'ID', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            roleSlugArray: { columnLabel: 'Roles', type: 'select', optionArray: [] },
            statusId: { columnLabel: 'Status', type: 'select', optionArray: [] },
            genderId: { columnLabel: 'Gender', type: 'select', optionArray: [] },
            firstName: { columnLabel: 'First name', type: 'text' },
            lastName: { columnLabel: 'Last name', type: 'text' },
            aboutDescription: { columnLabel: 'Description', type: 'text' },
            email: { columnLabel: 'E-mail', type: 'text' },
            phonePrefix: { columnLabel: 'Phone prefix', type: 'text' },
            phoneNumber: { columnLabel: 'Phone number', type: 'timestamp' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
        });

    let tableConfig =
        $derived({
            headerArray :
                [
                    { type: 'element', label: 'User name', key: 'userInfo' },
                    { type: 'string', label: 'Roles', key: 'roleSlugArray' },
                    { type: 'element', label: 'Status', key: 'status' },
                    { type: 'string', label: 'Gender', key: 'gender' },
                    { type: 'string', label: 'Phone', key: 'phone' },
                ],
            dataArray : $userArrayStore.map(
                ( user ) =>
                {
                    let userName = [ user.firstName, user.lastName ].join( ' ' );
                    let gender = user.genderId
                        ? getLocalizedText( $userGenderMap[ user.genderId ].name, $languageTagStore )
                        : 'Not informed';
                    let status = $userStatusMap[ user.statusId ];
                    let statusName = status
                        ? getLocalizedText( status.name, $languageTagStore )
                        : 'Not informed';
                    let statusColor = status.color;
                    let roleSlugArray = ( isArray( user.roleSlugArray ) && user.roleSlugArray.length > 0 )
                        ?  user.roleSlugArray.map( roleSlug => getLocalizedText( $userRoleMap[ roleSlug ].name, $languageTagStore ) )
                        : 'Not informed';
                    let phone = ( user.phonePrefix ? '(' + user.phonePrefix + ') ' : '' ) + ( user.phoneNumber ? user.phoneNumber : '' );

                    return (
                        {
                            ...user,
                            gender,
                            roleSlugArray,
                            status :
                                {
                                    component : Status,
                                    propMap :
                                        {
                                            name : statusName,
                                            color : statusColor
                                        }
                                },
                            userInfo :
                                {
                                    component : UserInfoCell,
                                    propMap :
                                        {
                                            userName,
                                            email : user.email,
                                            imagePath : user.imagePath
                                        }
                                },
                            phone
                        }
                        );
                }
                )
        });

    // -- FUNCTIONS

    function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isUserLoading && $hasMorePage )
        {
            loadUserArray( page );
            arrayProcessing();
        }
    }

    // ~~

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.roleSlugArray.optionArray = getOptionArray( $userRoleArray );
        filterableColumnByColumnNameMap.statusId.optionArray = getOptionArray( $userStatusArray );
        filterableColumnByColumnNameMap.genderId.optionArray = getOptionArray( $userGenderArray );
    }
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- CLASSES

    .page-section
    {
        min-height: 100dvh;
        padding-top: 4.5rem;

        display: grid;
        grid-template-columns: min-content 1fr;

        background: pageBackgroundColor;
    }

    .main-section
    {
        padding-bottom: 4.5rem;

        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
</style>

<AdminPage
    pageTitle="admin-menu-users-manager-label"
    selectedObject={ selectedUserStore }
    objectArrayStore={ userArrayStore }
    isObjectModalOpen={ isUserModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadUserArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateUser }
    handleEditObject={ handleEditUser }
    handleDeleteObject={ handleDeleteUser }
    toggleObjectModal={ () => {} }
    showButton={ hasUserPermission( 'add-user' ) }
    objectConfigMap={ tableConfig }
    isCustomTable={ true }
    handleNearBottom={ handleNearBottom }
    useModal={ false }
/>
