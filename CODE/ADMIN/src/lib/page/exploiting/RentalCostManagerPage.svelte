<script>
    // -- IMPORTS

    import AdminPage from '$component/element/AdminPage.svelte';
    import { getFormattedPrice, getOptionArray } from '$src/lib/base';
    import { languageTagStore } from '$src/lib/store/languageTagStore';
    import { currencyArrayStore } from '$src/lib/store/currencyArrayStore';
    import { hasUserPermission } from '$store/profileStore';
    import
    {
        handleCreateRentalCost,
        handleDeleteRentalCost,
        handleEditRentalCost,
        isRentalCostModalOpen,
        loadRentalCostArray,
        rentalCostArrayStore,
        selectedRentalCostStore,
        toggleRentalCostModal,
        isFormModified as isRentalCostFormModified,
        profileArrayStore,
        propertyArrayStore,
        rentalCostFrequencyArrayStore,
        rentalCostTypeArrayStore,
        hasMorePage,
        isRentalCostLoading,
        handleChange
    } from '$store/rentalCostStore';
    import { getLocalizedText } from 'senselogic-gist';
    import Input from '$component/element/Input.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import Select from '$component/element/Select.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-rental-cost-label',
        addTitle: 'add-rental-cost-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
        {
            id: { type: 'text', name: 'ID', value: '' },
            property: { type: 'property', name: 'Property', value: '' },
            typeName: { type: 'text', name: 'Type', value: '' },
            frequencyName: { type: 'text', name: 'Frequency', value: '' },
            name: { type: 'text', name: 'Name', value: '' },
            amount: { type: 'text', name: 'Amount', value: '' },
            currencyName: { type: 'text', name: 'Currency', value: '' },
            profile: { type: 'profile', name: 'User', value: '' }
        };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'ID', type: 'text' },
            propertyId: { columnLabel: 'Property ID', type: 'text' },
            typeId: { columnLabel: 'Type', type: 'select', optionArray: [] },
            frequencyId: { columnLabel: 'Frequency', type: 'select', optionArray: [] },
            name: { columnLabel: 'Name', type: 'text' },
            amount: { columnLabel: 'Amount', type: 'text' },
            currencyCode: { columnLabel: 'Currency', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Timestamp', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Timestamp', type: 'timestamp' },
        });
    // $: tableConfig =
    //     {
    //         headerArray:
    //             [
    //                 { type: 'text', label: 'ID', key: 'id' },
    //                 { type: 'property', label: 'Property', key: 'property' },
    //                 { type: 'text', label: 'Type', key: 'typeName' },
    //                 { type: 'text', label: 'Frequency', key: 'frequencyName' },
    //                 { type: 'text', label: 'Name', key: 'name' },
    //                 { type: 'text', label: 'Amount', key: 'amout' },
    //                 { type: 'amount', label: 'Currency', key: 'currencyName' },
    //                 { type: 'profile', label: 'User', key: 'profile' }
    //             ],
    //         dataArray: $rentalCostArrayStore
    //     };

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        $rentalCostArrayStore = $rentalCostArrayStore.map(
            rentalCost =>
            {
                let currency = $currencyArrayStore.find( currency => currency.code === rentalCost.currencyCode );
                let property = $propertyArrayStore.find( property => property.id === rentalCost.propertyId );
                let type = $rentalCostTypeArrayStore.find( rentalCostType => rentalCostType.id === rentalCost.typeId );
                let frequency = $rentalCostFrequencyArrayStore.find( rentalCostFrequency => rentalCostFrequency.id === rentalCost.frequencyId );
                let profile = $profileArrayStore.find( profile => profile.userId === rentalCost.userId );

                rentalCost.currency = currency;
                rentalCost.currencyName = getLocalizedText( currency?.singularName || '', $languageTagStore );
                rentalCost.property = property;
                rentalCost.type = type;
                rentalCost.typeName = getLocalizedText( type?.name || '', $languageTagStore );
                rentalCost.frequency = frequency;
                rentalCost.frequencyName = getLocalizedText( frequency?.name || '', $languageTagStore );
                rentalCost.profile = profile;

                return rentalCost;
            }
            );

        filterableColumnByColumnNameMap.frequencyId.optionArray = getOptionArray( $rentalCostFrequencyArrayStore );
        filterableColumnByColumnNameMap.typeId.optionArray = getOptionArray( $rentalCostTypeArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePage && !$isRentalCostLoading )
        {
            await loadRentalCostArray( page );
        }
    }

    // ~~

    function handleUpdateLocalizedInput(
        event
        )
    {
        handleChange();
        selectedRentalCostStore.update( ( rentalCost ) => ( { ...rentalCost, [ event.detail.name ]: event.detail.text } ) );
    }
</script>

<AdminPage
    pageTitle="admin-menu-rental-cost-label"
    selectedObject={ selectedRentalCostStore }
    objectArrayStore={ rentalCostArrayStore }
    isObjectModalOpen={ isRentalCostModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadRentalCostArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ () => handleCreateRentalCost( arrayProcessing ) }
    handleEditObject={ () => handleEditRentalCost( arrayProcessing ) }
    handleDeleteObject={ handleDeleteRentalCost }
    toggleObjectModal={ toggleRentalCostModal }
    showButton={ hasUserPermission( 'add-rental-cost' ) }
    isFormModified={ $isRentalCostFormModified }
    handleNearBottom={ handleNearBottom }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedRentalCostStore.id }
                fullWidth
                name="id"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width:100%;">
                <PropertySelect
                    bind:property={ $selectedRentalCostStore.property }
                    bind:propertyId={ $selectedRentalCostStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Type</span>
            <Select fullWidth name="typeId" bind:value={ $selectedRentalCostStore.typeId }>
                {#each $rentalCostTypeArrayStore as rentalCostType }
                    <option value={ rentalCostType.id }>{ getLocalizedText( rentalCostType.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Frequency</span>
            <Select fullWidth name="frequencyId" bind:value={ $selectedRentalCostStore.frequencyId }>
                {#each $rentalCostFrequencyArrayStore as rentalCostFrequency }
                    <option value={ rentalCostFrequency.id }>{ getLocalizedText( rentalCostFrequency.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Name</span>
            <InputLocalizedForm
                name="name"
                itemsString={ $selectedRentalCostStore.description }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Amount</span>
            <Input
                type="number"
                bind:value={ $selectedRentalCostStore.amount }
                fullWidth
                name="amount"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <svelte:fragment slot="start-adornment">
                    {@const selectedCurrencySymbol = $currencyArrayStore.find( currency => currency.code === $selectedRentalCostStore.currencyCode )?.symbol }
                    { selectedCurrencySymbol ?? 'ðŸ’²' }
                </svelte:fragment>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Currency</span>
            <Select fullWidth name="currencyCode" bind:value={ $selectedRentalCostStore.currencyCode }>
                {#each $currencyArrayStore as currency }
                    <option value={ currency.code }>{ getLocalizedText( currency?.singularName || '', $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedRentalCostStore.profile }
                    bind:userId={ $selectedRentalCostStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>
    </form>
</AdminPage>
