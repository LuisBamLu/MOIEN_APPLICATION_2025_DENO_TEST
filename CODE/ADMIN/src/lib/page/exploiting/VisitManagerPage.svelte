<script>
    // -- IMPORTS

    import { getLocalizedText } from 'senselogic-gist';
    import { getOptionArray } from '$lib/base';
    import { languageTagStore } from '$store/languageTagStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import
    {
        handleCreateVisit,
        handleDeleteVisit,
        handleEditVisit,
        isVisitModalOpen,
        loadVisitArray,
        profileArrayStore,
        propertyArrayStore,
        visitArrayStore,
        selectedVisitStore,
        toggleVisitModal,
        visitStatusArrayStore,
        isFormModified as isVisitFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        isVisitLoading,
        hasMorePage
    }
    from '$store/visitStore';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$src/lib/component/element/Input.svelte';
    import PropertySelect from '$src/lib/component/element/PropertySelect.svelte';
    import Select from '$src/lib/component/element/Select.svelte';
    import UserSelect from '$src/lib/component/element/UserSelect.svelte';

    // -- CONSTANTS

    const filterParameterByKeyMap =
    {
        id:
        {
            type: 'text',
            name: 'ID',
            value: ''
        },
        userName:
        {
            type: 'text',
            name: 'User',
            value: ''
        },
        visitorUserName:
        {
            type: 'text',
            name: 'Visitor',
            value: ''
        },
        statusName :
        {
            type: 'select',
            name: 'Status',
            optionArray: [],
            value: ''
        },
        propertyTitle :
        {
            type: 'text',
            name: 'Property',
            value: ''
        },
        date:
        {
            type: 'date',
            name: 'Date',
            value: new Date().toISOString()
        },
        time:
        {
            type: 'time',
            name: 'Time',
            value: '12:00:00'
        }
    };
    const titleSlugMap =
    {
        editTitle: 'edit-visit-label',
        addTitle: 'add-visit-label'
    };

    // -- VARIABLES

    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'Visit ID', type: 'text' },
            propertyId: { columnLabel: 'Property ID', type: 'text' },
            date: { columnLabel: 'Visit Date', type: 'date' },
            time: { columnLabel: 'Visit Time', type: 'time' },
            duration: { columnLabel: 'Visit Duration', type: 'text' },
            status: { columnLabel: 'Visit Status', type: 'select', optionArray: [] },
            visitorUserId: { columnLabel: 'Visitor User ID', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
        });
    let selectedVisitIndex = null;
    let searchTerm = '';
    let searchColumn = '';

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.status.optionArray = getOptionArray( $visitStatusArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePage && !$isVisitLoading )
        {
            await loadVisitArray( page );
        }
    }
</script>

<AdminPage
    pageTitle="admin-menu-visits-label"
    selectedObject={ selectedVisitStore }
    objectArrayStore={ visitArrayStore }
    isObjectModalOpen={ isVisitModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadVisitArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateVisit }
    handleEditObject={ handleEditVisit }
    handleDeleteObject={ handleDeleteVisit }
    toggleObjectModal={ toggleVisitModal }
    isFormModified={ $isVisitFormModified }
    showButton={ hasUserPermission( 'add-visit' ) }
    handleNearBottom={ handleNearBottom }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedVisitStore.id }
                fullWidth
                name="id"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width:100%;">
                <PropertySelect
                    bind:property={ $selectedVisitStore.property }
                    bind:propertyId={ $selectedVisitStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <div class="input-row">
                <span class="font-weight-700 line-height-150 color-gray-100">Date</span>
                <Input
                    type="date"
                    bind:value={ $selectedVisitStore.date }
                    fullWidth
                    name="date"
                />
            </div>

            <div class="input-row">
                <span class="font-weight-700 line-height-150 color-gray-100">Time</span>
                <Input
                    type="time"
                    bind:value={ $selectedVisitStore.time }
                    fullWidth
                    name="time"
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Duration</span>
            <Input
                type="time"
                bind:value={ $selectedVisitStore.duration }
                fullWidth
                name="duration"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Status</span>
            <Select fullWidth name="status" bind:value={ $selectedVisitStore.status }>
                {#each $visitStatusArrayStore as visitStatus }
                    <option value={ visitStatus.id }>{ getLocalizedText( visitStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Visitor</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedVisitStore.visitorProfile }
                    bind:userId={ $selectedVisitStore.visitorUserId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedVisitStore.profile }
                    bind:userId={ $selectedVisitStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>
    </form>
</AdminPage>
