<script>
    // -- IMPORTS

    import { getFormattedPrice, getCurrencySymbol } from '$lib/base';
    import { getLocalizedText } from 'senselogic-gist';
    import { getOptionArray } from '$lib/base';
    import { languageTagStore } from '$store/languageTagStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import
    {
        handleCreateLeaseSignatory,
        handleDeleteLeaseSignatory,
        handleEditLeaseSignatory,
        isLeaseSignatoryModalOpen,
        loadLeaseSignatoryArray,
        profileArrayStore,
        leaseSignatoryArrayStore,
        selectedLeaseSignatoryStore,
        toggleLeaseSignatoryModal,
        employmentStatusArrayStore,
        companyTypeArrayStore,
        contractArrayStore,
        isFormModified as isLeaseSignatoryFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        isLeaseSignatoryLoading,
        hasMorePage
    }
    from '$store/leaseSignatoryStore';
    import { countryArrayStore } from '$store/countryArrayStore';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import Switch from 'senselogic-flow/Switch.svelte';
    import Select from '$component/element/Select.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import { cityArrayStore } from '$store/cityArrayStore';

    // -- CONSTANTS

    const filterParameterByKeyMap =
    {
        id:
        {
            type: 'text',
            name: 'ID',
            value: ''
        },
        name:
        {
            type: 'text',
            name: 'Name',
            value: ''
        },
        birthDate:
        {
            type: 'date',
            name: 'Birth date',
            value: ''
        },
        address:
        {
            type: 'text',
            name: 'Address',
            value: ''
        },
        city:
        {
            type: 'text',
            name: 'City',
            value: ''
        },
        country:
        {
            type: 'text',
            name: 'Country',
            value: ''
        },
        formattedMonthlyIncome:
        {
            type: 'number',
            name: 'Monthly income',
            value: 0
        },
        employmentStatusId:
        {
            type: 'text',
            name: 'Employment status',
            value: ''
        },
        formattedDepositAmount:
        {
            type: 'number',
            name: 'Deposit amount',
            value: 0
        },
        companyName:
        {
            type: 'text',
            name: 'Company name',
            value: ''
        },
        companyType:
        {
            type: 'text',
            name: 'Company type',
            value: ''
        },
        companyRegistrationNumber:
        {
            type: 'text',
            name: 'Company registration number',
            value: ''
        },
        user:
        {
            type: 'text',
            name: 'User',
            value: ''
        },
        hasGuarantor:
        {
            type: 'boolean',
            name: 'Has guarantor',
            value: false
        },
        isMandated:
        {
            type: 'boolean',
            name: 'Mandated',
            value: false
        },
        hasDeposit:
        {
            type: 'boolean',
            name: 'Has deposit',
            value: false
        }
    };
    const titleSlugMap =
    {
        editTitle: 'edit-lease-signatory-label',
        addTitle: 'add-lease-signatory-label'
    };

    // -- VARIABLES

    let filterableColumnByColumnNameMap =
    $state({
        id: { columnLabel: 'Person ID', type: 'text' },
        contractId: { columnLabel: 'Contract ID', type: 'select', optionArray: [] },
        genderId: { columnLabel: 'Gender ID', type: 'select', optionArray: [] },
        firstName: { columnLabel: 'First Name', type: 'text' },
        lastName: { columnLabel: 'Last Name', type: 'text' },
        birthDate: { columnLabel: 'Birth Date', type: 'text' },
        addressLine1: { columnLabel: 'Address Line 1', type: 'text' },
        addressLine2: { columnLabel: 'Address Line 2', type: 'text' },
        cityCode: { columnLabel: 'City Code', type: 'text' },
        cityName: { columnLabel: 'City Name', type: 'text' },
        countryCode: { columnLabel: 'Country Code', type: 'text' },
        monthlyIncome: { columnLabel: 'Monthly Income', type: 'text' },
        employmentStatus: { columnLabel: 'Employment Status', type: 'select', optionArray: [] },
        hasDeposit: { columnLabel: 'Has Deposit', type: 'text' },
        depositAmount: { columnLabel: 'Deposit Amount', type: 'text' },
        hasGuarantor: { columnLabel: 'Has Guarantor', type: 'text' },
        isMandated: { columnLabel: 'Is Mandated', type: 'text' },
        companyName: { columnLabel: 'Company Name', type: 'text' },
        companyTypeId: { columnLabel: 'Company Type ID', type: 'select', optionArray: [] },
        companyRegistrationNumber: { columnLabel: 'Company Registration Number', type: 'text' },
        userId: { columnLabel: 'User ID', type: 'text' },
        creationTimestamp: { columnLabel: 'Creation Date', type: 'text' },
        updateTimestamp: { columnLabel: 'Update Date', type: 'text' }
    });
    let selectedLeaseSignatoryIndex = null;
    let searchTerm = '';
    let searchColumn = '';

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.contractId.optionArray = getOptionArray( $contractArrayStore );
        filterableColumnByColumnNameMap.genderId.optionArray = getOptionArray();
        filterableColumnByColumnNameMap.employmentStatus.optionArray = getOptionArray( $employmentStatusArrayStore );
        filterableColumnByColumnNameMap.companyTypeId.optionArray = getOptionArray( $companyTypeArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePage && !$isLeaseSignatoryLoading )
        {
            await loadLeaseSignatoryArray( page );
        }
    }
</script>

<AdminPage
    pageTitle="rental-file-page-lease-signatories-label"
    selectedObject={ selectedLeaseSignatoryStore }
    objectArrayStore={ leaseSignatoryArrayStore }
    isObjectModalOpen={ isLeaseSignatoryModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadLeaseSignatoryArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateLeaseSignatory }
    handleEditObject={ handleEditLeaseSignatory }
    handleDeleteObject={ handleDeleteLeaseSignatory }
    toggleObjectModal={ toggleLeaseSignatoryModal }
    isFormModified={ $isLeaseSignatoryFormModified }
    showButton={ hasUserPermission( 'add-lease-signatory' ) }
    handleNearBottom={ handleNearBottom }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.id }
                fullWidth
                name="text"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Name</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.name }
                fullWidth
                name="name"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Birth date</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.birthDate }
                fullWidth
                name="birthDate"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Address</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.address }
                fullWidth
                name="address"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">City</span>
            <Select fullWidth name="cityCode" bind:value={ $selectedLeaseSignatoryStore.cityCode }>
                {#each $cityArrayStore as employmentStatus }
                    <option value={ employmentStatus.id }>{ getLocalizedText( employmentStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Country</span>
            <Select fullWidth name="countryCode" bind:value={ $selectedLeaseSignatoryStore.countryCode }>
                {#each $countryArrayStore as employmentStatus }
                    <option value={ employmentStatus.code }>{ getLocalizedText( employmentStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Monthly income</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.monthlyIncome }
                fullWidth
                name="monthlyIncome"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseSignatoryStore.contract?.currencyCode ) || 'ðŸ’²' }</span>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Employment status</span>
            <Select fullWidth name="energyDiagnosisId" bind:value={ $selectedLeaseSignatoryStore.employmentStatus }>
                {#each $employmentStatusArrayStore as employmentStatus }
                    <option value={ employmentStatus.id }>{ getLocalizedText( employmentStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Deposit amount</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.depositAmount }
                fullWidth
                name="depositAmount"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedLeaseSignatoryStore.contract?.currencyCode ) || 'ðŸ’²' }</span>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Company type</span>
            <Select fullWidth name="companyTypeId" bind:value={ $selectedLeaseSignatoryStore.companyTypeId }>
                {#each $companyTypeArrayStore as companyType }
                    <option value={ companyType.id }>{ getLocalizedText( companyType.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Company registration number</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.companyRegistrationNumber }
                fullWidth
                name="companyRegistrationNumber"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedLeaseSignatoryStore.userProfile }
                    bind:userId={ $selectedLeaseSignatoryStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Company name</span>
            <Input
                type="text"
                bind:value={ $selectedLeaseSignatoryStore.companyName }
                fullWidth
                name="companyName"
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Has deposit</span>
            <Switch
                bind:value={ $selectedLeaseSignatoryStore.hasDeposit }
                onChange={ handleChange }
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Has guarantor</span>
            <Switch
                bind:value={ $selectedLeaseSignatoryStore.hasGuarantor }
                onChange={ handleChange }
            />
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Mandated</span>
            <Switch
                bind:value={ $selectedLeaseSignatoryStore.isMandated }
                onChange={ handleChange }
            />
        </div>
    </form>
</AdminPage>
