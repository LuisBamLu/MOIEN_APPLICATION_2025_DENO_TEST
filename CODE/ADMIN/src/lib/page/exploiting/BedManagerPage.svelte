<script>
    // -- IMPORTS

    import { getOptionArray } from '$lib/base';
    import
    {
        bedArrayStore,
        propertyArrayStore,
        spaceArrayStore,
        bedTypeArrayStore,
        isBedModalOpen,
        toggleBedModal,
        selectedBedStore,
        loadBedArray,
        handleCreateBed,
        handleEditBed,
        handleDeleteBed,
        profileArrayStore,
        isFormModified as isBedFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        isBedLoading,
        hasMorePage,
        isSubmitting
    }
    from '$store/bedStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import { languageTagStore } from '$store/languageTagStore';
    import ConfirmModal from '$component/element/ConfirmModal.svelte';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import Input from '$component/element/Input.svelte';
    import Select from '$component/element/Select.svelte';
    import Switch from '$component/element/Switch.svelte';
    import { getLocalizedText } from 'senselogic-gist';
    import { onMount } from 'svelte';
    import { urlParamsStore } from '$store/urlParamsStore';
    import PropertySelect from '$component/element/PropertySelect.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        propertyTitle:
        {
            type: 'text',
            name: 'Property',
            value: ''
        },
        spaceName:
        {
            type: 'text',
            name: 'Space',
            value: ''
        },
        bedType:
        {
            type: 'select',
            name: 'Type',
            optionArray: [],
            value: ''
        },
        personCount:
        {
            type: 'number',
            name: 'Capacity',
            value: 0
        },
        count:
        {
            type: 'number',
            name: 'Count',
            value: 0
        },
        userName:
        {
            type: 'text',
            name: 'Owner',
            value: ''
        }
    };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'ID', type: 'text' },
            propertyId: { columnLabel: 'Property ID', type: 'text' },
            spaceId: { columnLabel: 'Space ID', type: 'select', optionArray: [] },
            typeId: { columnLabel: 'Type ID', type: 'select', optionArray: [] },
            personCount: { columnLabel: 'Number of Persons', type: 'text' },
            count: { columnLabel: 'Count', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' },
        });

    let titleSlugMap =
    {
        editTitle: 'edit-bed-label',
        addTitle: 'add-bed-label'
    };

    let tableConfigMap =
        $derived({
            headerArray :
                [
                    { type: 'profile', label: 'Owner', key: 'userProfile' },
                    { type: 'property', label: 'Property', key: 'property' },
                    { type: 'text', label: 'Space', key: 'spaceName' },
                    { type: 'text', label: 'Type', key: 'bedType' },
                    { type: 'number', label: 'Capacity', key: 'personCount' },
                    { type: 'number', label: 'Count', key: 'count' }
                ],
            dataArray: $bedArrayStore
        });

    // -- FUNCTIONS

    function handleUpdateBedLocalizedInput(
        event
        )
    {
        handleChange();
        selectedBedStore.update( ( bed ) => ( { ...bed, [ event.detail.name ]: event.detail.text } ) );
    }

    // ~~

    async function loadMore(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isBedLoading && $hasMorePage )
        {
            await loadBedArray( page );
            arrayProcessing();
        }
    }

    // ~~

    export function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.spaceId.optionArray = getOptionArray( $spaceArrayStore );
        filterableColumnByColumnNameMap.typeId.optionArray = getOptionArray( $bedTypeArrayStore );
    }
</script>

<AdminPage
    pageTitle="admin-menu-beds-manager-label"
    selectedObject={ selectedBedStore }
    objectArrayStore={ bedArrayStore }
    isObjectModalOpen={ isBedModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadBedArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ () => handleCreateBed( arrayProcessing ) }
    handleEditObject={ () => handleEditBed( arrayProcessing ) }
    handleDeleteObject={ () => handleDeleteBed( arrayProcessing ) }
    toggleObjectModal={ toggleBedModal }
    showButton={ hasUserPermission( 'add-bed' ) }
    isFormModified={ $isBedFormModified }
    handleNearBottom={ loadMore }
    isCustomTable
    objectConfigMap={ tableConfigMap }
    isSubmitting={ $isSubmitting }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Property</span>
            <div style="width:100%;">
                <PropertySelect
                    bind:property={ $selectedBedStore.property }
                    bind:propertyId={ $selectedBedStore.propertyId }
                    on:change={ handleChange }
                    propertyArray={ $propertyArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Owner</span>
            <div style="width:100%;">
                <UserSelect
                    bind:profile={ $selectedBedStore.userProfile }
                    bind:userId={ $selectedBedStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Bed type</span>
            <Select fullWidth name="energyDiagnosisId" bind:value={ $selectedBedStore.typeId }>
                {#each $bedTypeArrayStore as bed }
                    <option value={ bed.id }>{ getLocalizedText( bed.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Count</span>
            <Input
                type="number"
                bind:value={ $selectedBedStore.count }
                fullWidth
                name="count"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Capacity</span>
            <Input
                type="number"
                bind:value={ $selectedBedStore.personCount }
                fullWidth
                name="personCount"
            />
        </div>
    </form>
</AdminPage>
