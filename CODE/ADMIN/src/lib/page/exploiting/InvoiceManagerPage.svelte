<script>
    // -- IMPORTS

    import
    {
        invoiceArrayStore,
        handleAddInvoice,
        handleDeleteInvoice,
        handleEditInvoice,
        isInvoiceModalOpen,
        loadInvoiceArray,
        selectedInvoiceStore,
        toggleInvoiceModal,
        billArrayStore,
        billLineArrayStore,
        profileArrayStore,
        isFormModified as isInvoiceFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        currencyArrayStore,
        isInvoiceLoading,
        hasMorePage

    } from '$store/invoiceStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';
    import { getLocalizedText } from 'senselogic-gist';
    import { languageTagStore } from '$store/languageTagStore';
    import Select from '$component/element/Select.svelte';
    import { getCurrencySymbol } from '$src/lib/base';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-invoice-label',
        addTitle: 'add-invoice-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        id:
        {
            type: 'text',
            name: 'ID',
            value: ''
        },
        title:
        {
            type: 'text',
            name: 'Title',
            value: ''
        },
        userName:
        {
            type: 'text',
            name: 'User name',
            value: ''
        },
        totalPrice:
        {
            type: 'number',
            name: 'Total price',
            value: ''
        },
        currencyCode:
        {
            type: 'text',
            name: 'Currency',
            optionArray: [],
            value: ''
        },
        creationTimestamp:
        {
            type: 'timestamp',
            name: 'Creation',
            value: ''
        },
        updateTimestamp:
        {
            type: 'timestamp',
            name: 'Update',
            value: ''
        }
    };
    let filterableColumnByColumnNameMap =
        {
            id: { columnLabel: 'Item ID', type: 'text' },
            title: { columnLabel: 'Title', type: 'text' },
            currencyCode: { columnLabel: 'Currency Code', type: 'text' },
            billIdArray: { columnLabel: 'Bill IDs', type: 'text' },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
        };

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        $invoiceArrayStore = $invoiceArrayStore.map(
            ( invoice ) =>
            {
                let billArray = $billArrayStore.filter(
                    ( bill ) => invoice.billIdArray.includes( bill.id )
                    );

                billArray = billArray.map(
                    ( bill ) =>
                    {
                        bill.totalPrice = $billLineArrayStore.filter(
                            ( billLine ) => billLine.billId === bill.id
                            )
                        .reduce(
                            ( sum, billLine ) => sum + billLine.totalPrice,
                            0
                            );

                        return bill;
                    }
                    );

                let totalPrice = billArray.reduce(
                    ( sum, bill ) => sum + bill.totalPrice,
                    0
                    );
                let profile = $profileArrayStore.find(
                    ( profile ) => profile.userId === invoice.userId
                    );

                invoice.totalPrice = totalPrice.toFixed( 2 );
                invoice.userName = profile ? `${ profile.firstName } ${ profile.lastName }` : 'Unknown';
                invoice.userProfile = profile;

                return invoice;
            }
            );

        $invoiceArrayStore = $invoiceArrayStore.sort(
            ( a, b ) => ( a.userId - b.userId || a.creationTimestamp - b.creationTimestamp )
            );
    }

    // ~~

    function handleUpdateInvoiceLocalizedInput(
        event
        )
    {
        handleChange();
        selectedInvoiceStore.update( ( invoice ) => ( { ...invoice, name: event.detail.text } ) );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePage && !$isInvoiceLoading )
        {
            await loadInvoiceArray( page );
            arrayProcessing();
        }
    }
</script>

<AdminPage
    pageTitle="admin-menu-invoice-label"
    selectedObject={ selectedInvoiceStore }
    objectArrayStore={ invoiceArrayStore }
    isObjectModalOpen={ isInvoiceModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadInvoiceArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleAddInvoice }
    handleEditObject={ handleEditInvoice }
    handleDeleteObject={ handleDeleteInvoice }
    toggleObjectModal={ toggleInvoiceModal }
    showButton={ hasUserPermission( 'add-invoice' ) }
    isFormModified={ $isInvoiceFormModified }
    handleNearBottom={ handleNearBottom }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedInvoiceStore.id }
                fullWidth
                name="id"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Title</span>
            <InputLocalizedForm
                name='title'
                itemsString={ $selectedInvoiceStore.title }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateInvoiceLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedInvoiceStore.userProfile }
                    bind:userId={ $selectedInvoiceStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Total price</span>
            <Input
                type="number"
                bind:value={ $selectedInvoiceStore.totalPrice }
                fullWidth
                name="number"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ getCurrencySymbol( $selectedInvoiceStore.currencyCode ) || 'ðŸ’²' }</span>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Currency</span>
            <Select fullWidth name="currencyCode" bind:value={ $selectedInvoiceStore.currencyCode }>
                {#each $currencyArrayStore as currency }
                    <option value="{ currency.code }">{ getLocalizedText( currency.singularName, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>
    </form>
</AdminPage>
