<script>
    import { run } from 'svelte/legacy';

    // -- IMPORTS

    import
    {
        selectedUserStore,
        userGenderArray,
        userRoleArray,
        userStatusArray,
        validationStatusArray
    } from '$store/userArrayStore';
    import ConfirmModal from '$component/element/ConfirmModal.svelte';
    import { fetchData, isNullOrUndefined } from '$lib/base';
    import { toast } from '$lib/toast';
    import { cityArrayStore } from '$store/cityArrayStore';
    import { countryArrayStore } from '$store/countryArrayStore';
    import { currencyArrayStore } from '$store/currencyArrayStore';
    import { getJsonText, getLocalizedText, getLocalizedTextBySlug } from 'senselogic-gist';
    import { getStorageImagePath } from '$lib/storage';
    import { languageArrayStore } from '$store/languageArrayStore';
    import { languageTagStore } from '$store/languageTagStore';
    import { onMount } from 'svelte';
    import BigPicture from 'bigpicture';
    import Button from '$component/element/Button.svelte';
    import Input from '$component/element/Input.svelte';
    import Loading from '$component/element/Loading.svelte';
    import PageTitle from '$component/element/PageTitle.svelte';
    import Select from '$component/element/Select.svelte';
    import Sidebar from '$component/layout/Sidebar.svelte';
    import { useConfirmationModal } from '$lib/confirmation_modal';
    import Svelecte from 'svelecte';
    import ProfileImage from '$component/element/ProfileImage.svelte';

    // -- CONSTANTS

    const pageTitle = 'back-label';

    // -- VARIABLES

    /** @type {{userId?: any}} */
    let { userId = null } = $props();
    let isSubmitting = $state(false);
    let isLoading;
    let {
            addNavigationEventListener,
            finalizeNavigation,
            handleChange,
            interceptNavigation,
            isConfirmationModalOpen,
            isFormModified,
            pendingNavigation,
            removeNavigationEventListener,
            toggleConfirmModal
        }
        = useConfirmationModal();

    $selectedUserStore =
        {
            ...$selectedUserStore,
            id : userId,
        };

    // -- FUNCTIONS

    function getInitialLoadingStatus(
        )
    {
        let hasSelectedUserProfile = !isNullOrUndefined( $selectedUserStore );

        return !hasSelectedUserProfile;
    }

    // ~~

    function handleOpenGallery(
        event
        )
    {
        let targetElement = event.target;

        BigPicture(
            {
                el: event.target,
                imgSrc: getStorageImagePath( $selectedUserStore.imagePath, 1280 ),
            }
            );
    }

    // ~~

    async function handleSave(
        )
    {
        isSubmitting = true;

        try
        {
            let { id : profileId, ...profile } = $selectedUserStore;

            await fetchData(
                '/admin/api/set-profile/' + profileId,
                {
                    credentials : 'include',
                    method : 'POST',
                    body : getJsonText(
                        {
                            profile
                        }
                        )
                }
                );

            toast(
                {
                    text : 'User updated successfully',
                    variant : 'success'
                }
                );

            isFormModified.set( false );
        }
        catch
        {
            toast(
                {
                    text : getLocalizedTextBySlug( 'no-permission-to-perform-action-label', $languageTagStore ),
                    variant : 'error'
                }
                );
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // -- STATEMENTS

    onMount(
        async () =>
        {
            addNavigationEventListener();
            isLoading = getInitialLoadingStatus();

            try
            {
                let response = await fetchData(
                    '/api/admin/page/users/' + userId,
                    {
                        method : 'POST',
                        credentials : 'include',
                    }
                    );

                selectedUserStore.set( response.profile );
                userGenderArray.set( response.userGenderArray );
                userRoleArray.set( response.userRoleArray );
                userStatusArray.set( response.userStatusArray );
                validationStatusArray.set( response.validationStatusArray );

                $selectedUserStore.firstName, $selectedUserStore.lastName, $selectedUserStore.legalName =
                    [ $selectedUserStore.firstName, $selectedUserStore.lastName ]
                        .filter( Boolean )
                        .join( ' ' );
            }
            catch ( error )
            {
                toast.error( getLocalizedTextBySlug( 'profile-not-found', $languageTagStore ) );
            }
            finally
            {
                isLoading = false;
            }

            return () => removeNavigationEventListener();
        }
        );
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- ELEMENTS

    fieldset
    {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
        align-self: stretch;
    }

    fieldset legend
    {
        margin-bottom: 1.5rem;

        line-height: 1.625rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: grayColor500;
    }

    // -- CLASSES

    .page-container
    {
        min-height: 100dvh;
        padding-top: 7vh;

        display: flex;

        background-color: grayColor900;
    }

    .manager-page
    {
        overflow-x: hidden;
        width: 100%;
        padding: 3em 4em 0;

        display: grid;
        grid-template-rows: min-content 1fr;

        +media( smaller-48em )
        {
            padding: 1em;
        }
    }

    .nav-section
    {
        width: 100%;
        max-width: 95dvw;
        border-bottom: 1px solid grayColor700;
        padding-bottom: 1.5rem;

        align-items: center;
    }

    .main-section
    {
        -ms-overflow-style: none;
        overflow: auto;
        scrollbar-width: none;
        max-height: calc( 100dvh - 13rem );
        width: 100%;
        max-width: 95dvw;
        padding: 3rem 0.5rem 4rem 0.5rem;

        display: flex;
        flex: 1 0 0;
        justify-content: center;
    }

    .main-section::-webkit-scrollbar
    {
        display: none;
    }

    .user-image
    {
        height: 5rem;
        width: 5rem;

        object-fit: cover;
        object-position: center;
        margin: 0 auto;
        border-radius: 50%;

        cursor: pointer;
    }

    .user-image-container
    {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
        align-self: stretch;
    }

    .username-and-email
    {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .divider
    {
        width: 100%;
        border-bottom: 1px solid grayColor700;
    }

    .main-content
    {
        width: 100%;
        max-width: 45rem;

        display: flex;
        flex-direction: column;
        gap: 3rem;
    }

    .input-row
    {
        width: 100%;

        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
        align-self: stretch;
    }

    .input-row.inline
    {
        display: initial;
    }
</style>

<ConfirmModal
    isOpen={ $isConfirmationModalOpen }
    onConfirm={ finalizeNavigation }
    onCancel={ toggleConfirmModal }
    confirmationText={ 'You have unsaved information, are you sure you wanna leave?' }
/>

<div class="page-container">
    <Sidebar/>
    <div class="manager-page">
        {#if isLoading }
            <Loading/>
        {:else}
            <nav class="display-flex gap-100 nav-section">
                <PageTitle
                    title={ pageTitle }
                />

                <Button
                    type="button"
                    on:click={ handleSave }
                    loading={ isSubmitting }
                    disabled={ !$isFormModified }
                >
                    Save
                </Button>
            </nav>

            <main class="main-section">
                <form class="main-content" onchange={handleChange}>
                    <div class="user-image-container">
                        <button
                            onclick={ handleOpenGallery }
                        >
                            <ProfileImage
                                size="large"
                                imagePath={ $selectedUserStore.imagePath }
                                userName={ $selectedUserStore.firstName }
                            />
                        </button>

                        <div class="username-and-email">
                            <h1 class="color-blue font-size-150 font-weight-600 line-height-200 text-align-center">{ [ $selectedUserStore.firstName, $selectedUserStore.lastName ].join( ' ' ) }</h1>
                            <p class="color-gray-300 font-size-100 font-weight-500 line-height-150 text-align-center">{ $selectedUserStore.email }</p>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <fieldset>
                        <legend>Person info</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">First name</span>
                            <Input disabled={ isSubmitting } fullWidth name="firstName" placeholder="Write the first name..." bind:value={ $selectedUserStore.firstName }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Last name</span>
                            <Input disabled={ isSubmitting } fullWidth name="lastName" placeholder="Write the last name..." bind:value={ $selectedUserStore.lastName }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Legal Name</span>
                            <Input
                                disabled={ isSubmitting }
                                fullWidth
                                name="legalName"
                                placeholder="Write the legal name..."
                                bind:value={ $selectedUserStore.legalName }
                                readonly
                            />
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Birthdate</span>
                            <Input
                                disabled={ isSubmitting }
                                fullWidth
                                name="birthdate"
                                bind:value={ $selectedUserStore.birthDate }
                                type="date"
                            />
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Gender</span>
                            <Select fullWidth name="genderId" bind:value={ $selectedUserStore.genderId }>
                                {#each $userGenderArray as gender }
                                    <option value={ gender.id }>{ getLocalizedText( gender.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>
                    </fieldset>

                    <div class="divider"></div>

                    <fieldset>
                        <legend>Account info</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
                            <Input disabled={ isSubmitting } fullWidth name="id" bind:value={ $selectedUserStore.id } readonly/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">User ID</span>
                            <Input disabled={ isSubmitting } fullWidth label="" name="userId" placeholder="Write the user ID..." bind:value={ $selectedUserStore.userId } readonly/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Mangopay User ID</span>
                            <Input disabled={ isSubmitting } fullWidth name="mangopayUserId" placeholder="Write the MangoPay user ID..." bind:value={ $selectedUserStore.mangopayUserId } readonly/>
                        </div>

                        <div class="input-row inline">
                            <span class="font-weight-700 line-height-150 color-gray-100">Role</span>
                            <Svelecte
                                required
                                name="roleSlugArray"
                                multiple
                                options={
                                            $userRoleArray.map(
                                                ( role ) =>
                                                    (
                                                        {
                                                            ...role,
                                                            name: getLocalizedText( role.name, $languageTagStore )
                                                        }
                                                    )
                                                )
                                        }
                                bind:value={ $selectedUserStore.roleSlugArray }
                                on:change={ handleChange }
                            />
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Status</span>
                            <Select fullWidth name="statusId" bind:value={ $selectedUserStore.statusId }>
                                {#each $userStatusArray as status }
                                    <option value={ status.id }>{ getLocalizedText( status.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Language</span>
                            <Select fullWidth name="languageTag" bind:value={ $selectedUserStore.languageTag }>
                                {#each $languageArrayStore as language }
                                    <option value={ language.tag }>{ getLocalizedText( language.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Currency</span>
                            <Select fullWidth name="currencyCode" bind:value={ $selectedUserStore.currencyCode }>
                                {#each $currencyArrayStore as currency }
                                    <option value={ currency.code }>{ getLocalizedText( currency.singularName, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>
                    </fieldset>

                    <div class="divider"></div>

                    <fieldset>
                        <legend>Contact info</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Email</span>
                            <Input disabled={ isSubmitting } fullWidth name="email" placeholder="youremail@mail.com..." bind:value={ $selectedUserStore.email }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Email validation status</span>
                            <Select fullWidth name="emailValidationStatusId" bind:value={ $selectedUserStore.emailValidationStatusId }>
                                {#each $validationStatusArray as validationStatus }
                                    <option value={ validationStatus.id }>{ getLocalizedText( validationStatus.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Phone Prefix</span>
                            <Select fullWidth name="phonePrefix" bind:value={ $selectedUserStore.phonePrefix }>
                                {#each $countryArrayStore as country }
                                    <option value={ country.phonePrefix }>
                                        { country.phonePrefix }
                                    </option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Phone Number</span>
                            <Input disabled={ isSubmitting } fullWidth name="phoneNumber" placeholder="Write the phone number..." bind:value={ $selectedUserStore.phoneNumber }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Phone Number validation status</span>
                            <Select fullWidth name="phoneNumberValidationStatusId" bind:value={ $selectedUserStore.phoneNumberValidationStatusId }>
                                {#each $validationStatusArray as validationStatus }
                                    <option value={ validationStatus.id }>{ getLocalizedText( validationStatus.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>
                    </fieldset>

                    <div class="divider"></div>

                    <fieldset>
                        <legend>Address info</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Address Line 1</span>
                            <Input disabled={ isSubmitting } fullWidth name="addressLine1" placeholder="Write the address line 1..." bind:value={ $selectedUserStore.addressLine1 }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Address Line 2</span>
                            <Input disabled={ isSubmitting } fullWidth name="addressLine2" placeholder="Write the address line 2..." bind:value={ $selectedUserStore.addressLine2 }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">City name</span>
                            <Select fullWidth name="cityName" bind:value={ $selectedUserStore.cityName }>
                                {#each $cityArrayStore as city }
                                    <option value="{ city.name }">{ city.name }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Country</span>
                            <Select fullWidth name="countryCode" bind:value={ $selectedUserStore.countryCode }>
                                {#each $countryArrayStore as country }
                                    <option value="{ country.code }">{ getLocalizedText( country.name, $languageTagStore ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">About description</span>
                            <Input disabled={ isSubmitting } multiline rows={ 5 } fullWidth name="aboutDescription" bind:value={ $selectedUserStore.aboutDescription }/>
                        </div>
                    </fieldset>
                </form>
            </main>
        {/if}
    </div>
</div>
