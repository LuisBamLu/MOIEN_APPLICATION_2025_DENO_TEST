<script>
    // -- IMPORTS

    import
    {
        notificationPermissionArrayStore,
        profileArrayStore,
        notificationTypeArrayStore,
        notificationMediumArrayStore,
        selectedNotificationPermissionStore,
        isNotificationPermissionModalOpen,
        loadNotificationPermissionArray,
        handleCreateNotificationPermission,
        handleDeleteNotificationPermission,
        handleEditNotificationPermission,
        toggleNotificationPermissionModal,
        isFormModified as isNotificationPermissionFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        isNotificationPermissionLoading,
        hasMorePageStore
    }
    from '$store/notificationPermissionStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { getOptionArray } from '$lib/base';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$component/element/Input.svelte';
    import UserSelect from '$src/lib/component/element/UserSelect.svelte';
    import Switch from 'senselogic-flow/Switch.svelte';
    import Select from '$src/lib/component/element/Select.svelte';
    import { getLocalizedText } from 'senselogic-gist';
    import { languageTagStore } from '$src/lib/store/languageTagStore';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-notification-permission-label',
        addTitle: 'add-notification-permission-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        id:
        {
            type: 'text',
            name: 'ID',
            value: ''
        },
        userName:
        {
            type: 'text',
            name: 'User',
            value: ''
        },
        isGranted:
        {
            type: 'boolean',
            name: 'Granted',
            value: ''
        },
        notificationType:
        {
            type: 'select',
            name: 'Type',
            optionArray: [],
            value: ''
        },
        notificationMedium:
        {
            type: 'select',
            name: 'Medium',
            optionArray: [],
            value: ''
        }
    };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'Notification ID', type: 'text' },
            notificationType: { columnLabel: 'Notification Type', type: 'select', optionArray: [] },
            notificationMedium: { columnLabel: 'Notification Medium', type: 'select', optionArray: [] },
            isGranted: { columnLabel: 'Permission Granted', type: 'boolean' },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'timestamp' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'timestamp' }
        });

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.notificationType.optionArray = getOptionArray( $notificationTypeArrayStore );
        filterableColumnByColumnNameMap.notificationMedium.optionArray = getOptionArray( $notificationMediumArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( $hasMorePageStore && !$isNotificationPermissionLoading )
        {
            loadNotificationPermissionArray( page );
        }
    }
</script>

<AdminPage
    pageTitle="admin-menu-notification-permission-label"
    selectedObject={ selectedNotificationPermissionStore }
    objectArrayStore={ notificationPermissionArrayStore }
    isObjectModalOpen={ isNotificationPermissionModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadNotificationPermissionArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ handleCreateNotificationPermission }
    handleEditObject={ handleEditNotificationPermission }
    handleDeleteObject={ handleDeleteNotificationPermission }
    toggleObjectModal={ toggleNotificationPermissionModal }
    showButton={ hasUserPermission( 'add-notification-medium' ) }
    isFormModified={ $isNotificationPermissionFormModified }
    handleNearBottom={ handleNearBottom }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">ID</span>
            <Input
                type="text"
                bind:value={ $selectedNotificationPermissionStore.id }
                fullWidth
                name="id"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedNotificationPermissionStore.userProfile }
                    bind:userId={ $selectedNotificationPermissionStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Notification type</span>
            <Select fullWidth name="notificationType" bind:value={ $selectedNotificationPermissionStore.notificationType }>
                {#each $notificationTypeArrayStore as notificationType }
                    <option value={ notificationType.id }>{ getLocalizedText( notificationType.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Notification medium</span>
            <Select fullWidth name="notificationMedium" bind:value={ $selectedNotificationPermissionStore.notificationMedium }>
                {#each $notificationMediumArrayStore as notificationMedium }
                    <option value={ notificationMedium.id }>{ getLocalizedText( notificationMedium.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row space-between inline">
            <span class="font-weight-700 line-height-150 color-gray-100">Granted</span>
            <Switch
                onChange={ handleChange }
                bind:value={ $selectedNotificationPermissionStore.isGranted }
            />
        </div>
    </form>
</AdminPage>
