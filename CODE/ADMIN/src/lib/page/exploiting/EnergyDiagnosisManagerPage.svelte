<script>
    // -- IMPORTS

    import
    {
        diagnosisArrayStore,
        handleCreateDiagnosis,
        handleDeleteDiagnosis,
        handleEditDiagnosis,
        isDiagnosisModalOpen,
        loadDiagnosisArray,
        selectedDiagnosisStore,
        toggleDiagnosisModal,
        isFormModified as isDiagnosisFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        isSubmitting
    }
    from '$store/diagnosisStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import Input from '$src/lib/component/element/Input.svelte';
    import InputLocalizedForm from '$src/lib/component/element/InputLocalizedForm.svelte';
    import { languageArrayStore } from '$src/lib/store/languageArrayStore';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-diagnosis-label',
        addTitle: 'add-diagnosis-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        name:
        {
            type: 'text',
            name: 'Name',
            value: ''
        },
        number:
        {
            type: 'number',
            name: 'Number',
            value: ''
        },
        minimumValue:
        {
            type: 'number',
            name: 'Min value',
            value: ''
        },
        maximumValue:
        {
            type: 'number',
            name: 'Max value',
            value: ''
        },
        creationTimestamp:
        {
            type: 'timestamp',
            name: 'Creation',
            value: ''
        },
        updateTimestamp:
        {
            type: 'timestamp',
            name: 'Update',
            value: ''
        }
    };

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        $diagnosisArrayStore = $diagnosisArrayStore.sort(
            ( a, b ) => ( a.minimumValue - b.minimumValue || a.name - b.name )
            );
    }

    // ~~

    function handleUpdateDiagnosisLocalizedInput(
        event
        )
    {
        handleChange();
        selectedDiagnosisStore.update( ( diagnosis ) => ( { ...diagnosis, [ event.detail.name ]: event.detail.text } ) );
    }
</script>

<AdminPage
    pageTitle="admin-menu-diagnosis-label"
    selectedObject={ selectedDiagnosisStore }
    objectArrayStore={ diagnosisArrayStore }
    isObjectModalOpen={ isDiagnosisModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadDiagnosisArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ () => handleCreateDiagnosis( arrayProcessing ) }
    handleEditObject={ () => handleEditDiagnosis( arrayProcessing ) }
    handleDeleteObject={ () => handleDeleteDiagnosis( arrayProcessing ) }
    toggleObjectModal={ toggleDiagnosisModal }
    showButton={ hasUserPermission( 'add-diagnosis' ) }
    isFormModified={ $isDiagnosisFormModified }
    search={ false }
    isSubmitting={ $isSubmitting }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Name</span>
            <InputLocalizedForm
                name="name"
                itemsString={ $selectedDiagnosisStore.name }
                languageArray={ $languageArrayStore }
                on:update={ handleUpdateDiagnosisLocalizedInput }
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Number</span>
            <Input
                type="number"
                bind:value={ $selectedDiagnosisStore.number }
                fullWidth
                name="number"
            />
        </div>

        <div class="input-row inline">
            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Minimum value</span>
                <Input
                    type="number"
                    bind:value={ $selectedDiagnosisStore.minimumValue }
                    fullWidth
                    name="number"
                />
            </div>

            <div class="input-row flex-grow">
                <span class="font-weight-700 line-height-150 color-gray-100">Maximum value</span>
                <Input
                    type="number"
                    bind:value={ $selectedDiagnosisStore.maximumValue }
                    fullWidth
                    name="number"
                />
            </div>
        </div>
    </form>
</AdminPage>
