<script>
    // -- IMPORTS

    import
    {
        countryArrayStore,
        languageArrayStore,
        loadDocumentArray,
        selectedDocumentStore,
        validationStatusArrayStore
    }
    from '$store/documentStore';
    import ConfirmModal from '$component/element/ConfirmModal.svelte';
    import { fetchData, isNullOrUndefined } from '$lib/base';
    import { getJsonText, getLocalizedText, getLocalizedTextBySlug } from 'senselogic-gist';
    import { getStorageImagePath } from '$lib/storage';
    import { hasAllUserRoles, hasUserRole } from '$store/profileStore';
    import { onMount } from 'svelte';
    import { toast } from '$lib/toast';
    import BigPicture from 'bigpicture';
    import Button from '$component/element/Button.svelte';
    import Input from '$component/element/Input.svelte';
    import Loading from '$component/element/Loading.svelte';
    import PageTitle from '$component/element/PageTitle.svelte';
    import Select from '$component/element/Select.svelte';
    import Sidebar from '$component/layout/Sidebar.svelte';
    import Svelecte from 'svelecte';
    import { useConfirmationModal } from '$lib/confirmation_modal';
    import ActionButton from '$src/lib/component/element/ActionButton.svelte';

    // -- CONSTANTS

    const pageTitle = 'back-label';

    // -- VARIABLES

    /** @type {{documentId?: any}} */
    let { documentId = null } = $props();
    let isLoading = $state(getInitialLoadingStatus());
    let isSubmitting = $state(false);
    let documentTypeArray = $state([]);
    let
    {
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        isFormModified,
        removeNavigationEventListener,
        toggleConfirmModal
    } = useConfirmationModal();

    // -- FUNCTIONS

    function getInitialLoadingStatus(
        )
    {
        let hasSelectedDocument = !isNullOrUndefined( $selectedDocumentStore );

        return !hasSelectedDocument;
    }

    // ~~

    async function handleAcceptDocument(
        )
    {
        isSubmitting = true;

        try
        {
            let response = await fetchData(
                '/admin/api/document/' + $selectedDocumentStore.id + '/accept',
                {
                    credentials : 'include',
                    method : 'POST',
                    body: getJsonText(
                        {
                            document: $selectedDocumentStore
                        }
                        )
                }
                );

            toast.success( getLocalizedTextBySlug( response.message ) );
            isFormModified.set( false );
            selectedDocumentStore.set(
                {
                    ...$selectedDocumentStore,
                    validationStatusId: 'accepted'
                }
                );
        }
        catch ( error )
        {
            toast.error( getLocalizedTextBySlug( error.message ) );
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // ~~

    async function handleDeclineDocument(
        )
    {
        isSubmitting = true;

        try
        {
            let response = await fetchData(
                '/admin/api/document/' + $selectedDocumentStore.id + '/decline',
                {
                    credentials : 'include',
                    method : 'POST',
                    body: getJsonText(
                        {
                            document: $selectedDocumentStore
                        }
                        )
                }
                );

            toast.success( getLocalizedTextBySlug( response.message ) );
            isFormModified.set( false );
            selectedDocumentStore.set(
                {
                    ...$selectedDocumentStore,
                    validationStatusId: 'declined'
                }
                );
        }
        catch ( error )
        {
            toast.error( getLocalizedTextBySlug( error.message ) );
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // ~~

    async function handleSave(
        )
    {
        isSubmitting = true;

        try
        {
            let response = await fetchData(
                '/api/document/update',
                {
                    credentials : 'include',
                    method : 'POST',
                    body : getJsonText(
                        {
                            document : $selectedDocumentStore
                        }
                        )
                }
                );

            toast.success( getLocalizedTextBySlug( response.message ) );
            isFormModified.set( false );
        }
        catch ( error )
        {
            toast.error( getLocalizedTextBySlug( error.message ) );
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // -- STATEMENTS

    onMount(
        async () =>
        {
            isLoading = getInitialLoadingStatus();

            try
            {
                await loadDocumentArray( 1, 10 );

                let [
                        documentTypeResponse,
                        documentResponse
                    ] = await Promise.all(
                        [
                            fetchData(
                                '/api/document-type/list',
                                {
                                    credentials : 'include',
                                    method : 'POST',
                                }
                                ),
                            fetchData(
                                '/api/admin/page/document-manager/' + documentId,
                                {
                                    credentials : 'include',
                                    method : 'POST',
                                }
                                )
                        ]
                        );

                addNavigationEventListener();

                selectedDocumentStore.set( documentResponse.document );
                documentTypeArray = documentTypeResponse.documentTypeArray;

                $selectedDocumentStore =
                    {
                        ...$selectedDocumentStore,
                        id : documentId,
                    };
            }
            catch ( error )
            {
                toast.error( error.message );
            }
            finally
            {
                isLoading = false;
            }

            return () => removeNavigationEventListener();
        }
        );
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- ELEMENTS

    fieldset
    {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
        align-self: stretch;
    }

    fieldset legend
    {
        margin-bottom: 1.5rem;

        line-height: 1.625rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: grayColor500;
    }

    // -- CLASSES

    .page-container
    {
        min-height: 100vh;
        padding-top: 7vh;

        display: flex;

        background-color: grayColor900;
    }

    .manager-page
    {
        overflow-x: hidden;
        width: 100%;
        padding: 3em 4em 0;

        display: grid;
        grid-template-rows: min-content 1fr;
    }

    .nav-section
    {
        width: 100%;
        border-bottom: 1px solid grayColor700;
        padding-bottom: 1.5rem;
    }

    .main-section
    {
        -ms-overflow-style: none;
        overflow: auto;
        scrollbar-width: none;
        max-height: calc( 100vh - 13rem );
        width: 100%;
        padding: 3rem 0.5rem 4rem 0.5rem;

        display: flex;
        flex: 1 0 0;
        justify-content: center;
    }

    .main-section::-webkit-scrollbar
    {
        display: none;
    }

    .document-image
    {
        height: 5rem;
        width: 5rem;

        object-fit: cover;
        object-position: center;
        margin: 0 auto;
        border-radius: 50%;

        cursor: pointer;
    }

    .document-image-container
    {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
        align-self: stretch;
    }

    .document-name-and-description
    {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .divider
    {
        width: 100%;
        border-bottom: 1px solid grayColor700;
    }

    .main-content
    {
        width: 100%;
        max-width: 45rem;

        display: flex;
        flex-direction: column;
        gap: 3rem;
    }

    .input-row
    {
        width: 100%;

        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
        align-self: stretch;
    }

    .svelecte-container
    {
        width: 100%;
    }

    .status-select-container
    {
        width: 100%;

        display: grid;
        grid-template-columns: 1fr min-content min-content;
        gap: 0.5rem;
        align-items: center;
    }
</style>

<ConfirmModal
    isOpen={ $isConfirmationModalOpen }
    onConfirm={ finalizeNavigation }
    onCancel={ toggleConfirmModal }
    confirmationText={ 'You have unsaved information, are you sure you wanna leave?' }
/>

<div class="page-container">
    <Sidebar/>
    <div class="manager-page">
        {#if isLoading }
            <Loading/>
        {:else}
            <nav class="display-flex gap-100 nav-section">
                <PageTitle
                    title={ pageTitle }
                />

                <Button
                    type="button"
                    on:click={ handleSave }
                    loading={ isSubmitting }
                    disabled={ !isFormModified }
                >
                    Save
                </Button>
            </nav>

            <main class="main-section">
                <form class="main-content" onchange={handleChange}>
                    <div class="document-image-container">
                        <button                        >
                            <img
                                src={ getStorageImagePath( $selectedDocumentStore.filePath, 360 ) }
                                alt={ $selectedDocumentStore.name }
                                class="document-image"
                            />
                        </button>

                        <div class="document-name-and-description">
                            <h1 class="color-blue font-size-150 font-weight-600 line-height-200 text-align-center">{ $selectedDocumentStore.name ?? 'Not informed' }</h1>
                            <p class="color-gray-300 font-size-100 font-weight-500 line-height-150 text-align-center">{ $selectedDocumentStore.description ??'Not informed' }</p>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <fieldset>
                        <legend>Document</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Document name</span>
                            <Input disabled={ isSubmitting } fullWidth name="name" bind:value={ $selectedDocumentStore.name }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">MangoPay document ID</span>
                            <Input disabled={ isSubmitting } fullWidth name="mangopayDocumentId" bind:value={ $selectedDocumentStore.mangopayDocumentId } readonly={ !hasUserRole( 'administrator' ) }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
                            <div style="width: 100%;">
                                <!-- <UserSelect
                                    bind:userId={ $selectedDocumentStore.userId }
                                    bind:profile={ $selectedDocumentStore.profile }
                                    on:change={ handleChange }
                                    profileArray={ $selectedDocumentStore.profile ? Array.of( $selectedDocumentStore.profile ) : [] }
                                /> -->
                            </div>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Document Type</span>
                            <Select fullWidth name="typeId" bind:value={ $selectedDocumentStore.typeId }>
                                {#each documentTypeArray as documentType }
                                    <option value={ documentType.id }>{ getLocalizedText( documentType.name ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Validation status</span>
                            <div class="status-select-container">
                                <Select disabled={ !hasAllUserRoles( [ 'administrator' ] ) } fullWidth name="validationStatusId" bind:value={ $selectedDocumentStore.validationStatusId }>
                                    {#each $validationStatusArrayStore as validationStatus }
                                        <option value={ validationStatus.id }>{ getLocalizedText( validationStatus.name ) }</option>
                                    {/each}
                                </Select>
                                {#if $selectedDocumentStore.validationStatusId === 'pending'}
                                    <ActionButton
                                        on:click={ handleDeclineDocument }
                                        variant="decline"
                                    >
                                        Decline
                                    </ActionButton>
                                    <ActionButton
                                        on:click={ handleAcceptDocument }
                                    >
                                    Accept
                                    </ActionButton>
                                {/if}
                            </div>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Expiration date</span>
                            <Input type="date" disabled={ isSubmitting } fullWidth name="expirationDate" bind:value={ $selectedDocumentStore.expirationDate }/>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Language</span>
                            <Select fullWidth name="languageTag" bind:value={ $selectedDocumentStore.languageTag }>
                                {#each $languageArrayStore as language }
                                    <option value={ language.tag }>{ getLocalizedText( language.name ) }</option>
                                {/each}
                            </Select>
                        </div>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Country</span>

                            <div class="svelecte-container">
                                <Svelecte
                                    required
                                    name="categoryIdArray"
                                    multiple
                                    options={
                                                $countryArrayStore.map(
                                                    ( country ) =>
                                                        (
                                                            {
                                                                ...country,
                                                                name: getLocalizedText( country.name )
                                                            }
                                                        )
                                                    )
                                            }
                                    bind:value={ $selectedDocumentStore.countryIdArray }
                                />
                            </div>
                        </div>
                    </fieldset>

                <fieldset>
                        <legend>Description</legend>

                        <div class="input-row">
                            <span class="font-weight-700 line-height-150 color-gray-100">Document description</span>
                            <Input disabled={ isSubmitting } multiline rows={ 5 } fullWidth name="description" bind:value={ $selectedDocumentStore.description }/>
                        </div>
                    </fieldset>
                </form>
            </main>
        {/if}
    </div>
</div>
