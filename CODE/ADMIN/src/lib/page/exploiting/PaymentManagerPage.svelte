<script>
    // -- IMPORTS

    import { formatDate, getFormattedPrice, getOptionArray } from '$lib/base';
    import
    {
        paymentArrayStore,
        profileArrayStore,
        currencyCodeArrayStore,
        paymentTypeArrayStore,
        paymentStatusArrayStore,
        selectedPaymentStore,
        isPaymentModalOpen,
        loadPaymentArray,
        handleEditPayment,
        handleCreatePayment,
        handleDeletePayment,
        togglePaymentModal,
        isPaymentLoading,
        hasMorePage,
        isFormModified as isPaymentFormModified,
        addNavigationEventListener,
        finalizeNavigation,
        handleChange,
        isConfirmationModalOpen,
        removeNavigationEventListener,
        toggleConfirmModal,
        paymentMethodArrayStore,
        isSubmitting
    }
    from '$store/paymentStore';
    import AdminPage from '$component/element/AdminPage.svelte';
    import { hasUserPermission } from '$store/profileStore';
    import { getLocalizedText, getLocalizedTextBySlug } from 'senselogic-gist';
    import { languageTagStore } from '$store/languageTagStore';
    import InputLocalizedForm from '$component/element/InputLocalizedForm.svelte';
    import { languageArrayStore } from '$store/languageArrayStore';
    import Input from '$component/element/Input.svelte';
    import Switch from '$component/element/Switch.svelte';
    import Select from '$component/element/Select.svelte';
    import UserSelect from '$component/element/UserSelect.svelte';

    // -- CONSTANTS

    const titleSlugMap =
    {
        editTitle: 'edit-payment-label',
        addTitle: 'add-payment-label'
    };

    // -- VARIABLES

    let filterParameterByKeyMap =
    {
        id:
        {
            type: 'text',
            name: 'ID',
            value: ''
        },
        type:
        {
            type: 'select',
            name: 'Type',
            optionArray: [],
            value: ''
        },
        payerUserProfileName:
        {
            type: 'text',
            name: 'Payer',
            value: ''
        },
        payeeUserProfileName:
        {
            type: 'text',
            name: 'Payee',
            value: ''
        },
        formattedAmount:
        {
            type: 'number',
            name: 'Amount',
            value: ''
        },
        currencyName:
        {
            type: 'select',
            name: 'Currency',
            optionArray: [],
            value: ''
        },
        formattedInvoiceDate:
        {
            type: 'date',
            name: 'Invoice Date',
            value: ''
        },
        formattedDueDate:
        {
            type: 'date',
            name: 'Invoice Date',
            value: ''
        },
        status:
        {
            type: 'select',
            name: 'Status',
            optionArray: [],
            value: ''
        },
        userProfileName:
        {
            type: 'text',
            name: 'User',
            value: ''
        }
    };
    let filterableColumnByColumnNameMap =
        $state({
            id: { columnLabel: 'Transaction ID', type: 'text' },
            typeId: { columnLabel: 'Transaction Type', type: 'select', optionArray: [] },
            methodId: { columnLabel: 'Payment Method', type: 'select', optionArray: [] },
            payerUserProfileId: { columnLabel: 'Payer Profile ID', type: 'text' },
            payeeUserProfileId: { columnLabel: 'Payee Profile ID', type: 'text' },
            amount: { columnLabel: 'Amount', type: 'text' },
            currencyCode: { columnLabel: 'Currency Code', type: 'text' },
            invoiceDate: { columnLabel: 'Invoice Date', type: 'text' },
            dueDate: { columnLabel: 'Due Date', type: 'text' },
            transactionId: { columnLabel: 'Transaction Reference ID', type: 'text' },
            mangopayId: { columnLabel: 'Mangopay ID', type: 'text' },
            statusId: { columnLabel: 'Status', type: 'select', optionArray: [] },
            userId: { columnLabel: 'User ID', type: 'text' },
            creationTimestamp: { columnLabel: 'Creation Date', type: 'text' },
            updateTimestamp: { columnLabel: 'Update Date', type: 'text' }
        });
    let currencySymbol = $derived($currencyCodeArrayStore.find( ( _currency ) => _currency.code === $selectedPaymentStore?.currencyCode ));

    // -- FUNCTIONS

    function arrayProcessing(
        )
    {
        filterableColumnByColumnNameMap.typeId.optionArray = getOptionArray( $paymentTypeArrayStore );
        filterableColumnByColumnNameMap.methodId.optionArray = getOptionArray( $paymentMethodArrayStore );
        filterableColumnByColumnNameMap.statusId.optionArray = getOptionArray( $paymentStatusArrayStore );
    }

    // ~~

    async function handleNearBottom(
        event
        )
    {
        let { page } = event.detail;

        if ( !$isPaymentLoading && $hasMorePage )
        {
            await loadPaymentArray( page );
            arrayProcessing();
        }
    }
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- CLASSES
</style>

<AdminPage
    pageTitle="admin-menu-payments-label"
    selectedObject={ selectedPaymentStore }
    objectArrayStore={ paymentArrayStore }
    isObjectModalOpen={ isPaymentModalOpen }
    filterParameterByKeyMap={ filterParameterByKeyMap }
    filterableColumnByColumnNameMap={ filterableColumnByColumnNameMap }
    titleSlugMap={ titleSlugMap }
    loadObjectArray={ loadPaymentArray }
    arrayProcessing={ arrayProcessing }
    handleCreateObject={ () => handleCreatePayment( arrayProcessing ) }
    handleEditObject={ () => handleEditPayment( arrayProcessing ) }
    handleDeleteObject={ () => handleDeletePayment( arrayProcessing ) }
    toggleObjectModal={ togglePaymentModal }
    showButton={ hasUserPermission( 'add-payment' ) }
    isFormModified={ $isPaymentFormModified }
    handleNearBottom={ handleNearBottom }
    isSubmitting={ $isSubmitting }
>
    <form onchange={handleChange} class="edit-modal-form">
        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Payment type</span>
            <Select fullWidth name="typeId" bind:value={ $selectedPaymentStore.typeId }>
                {#each $paymentTypeArrayStore as paymentType }
                    <option value={ paymentType.id }>{ getLocalizedText( paymentType.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Payment method</span>
            <Select fullWidth name="methodId" bind:value={ $selectedPaymentStore.methodId }>
                {#each $paymentMethodArrayStore as paymentMethod }
                    <option value={ paymentMethod.id }>{ getLocalizedText( paymentMethod.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Payment status</span>
            <Select fullWidth name="methodId" bind:value={ $selectedPaymentStore.statusId }>
                {#each $paymentStatusArrayStore as paymentStatus }
                    <option value={ paymentStatus.id }>{ getLocalizedText( paymentStatus.name, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Payee</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedPaymentStore.payeeProfile }
                    bind:userId={ $selectedPaymentStore.payeeUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Payeer</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedPaymentStore.payerProfile }
                    bind:userId={ $selectedPaymentStore.payerUserProfileId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Amount</span>
            <Input
                type="number"
                bind:value={ $selectedPaymentStore.amount }
                fullWidth
                name="amount"
            >
                <!-- @migration-task: migrate this slot by hand, `start-adornment` is an invalid identifier -->
    <span slot="start-adornment">{ currencySymbol?.symbol || 'ðŸ’²' }</span>
            </Input>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Currency</span>
            <Select fullWidth name="currencyCode" bind:value={ $selectedPaymentStore.currencyCode }>
                {#each $currencyCodeArrayStore as currencyCode }
                    <option value={ currencyCode.code }>{ getLocalizedText( currencyCode.pluralName, $languageTagStore ) }</option>
                {/each}
            </Select>
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Invoice date</span>
            <Input
                type="date"
                bind:value={ $selectedPaymentStore.invoiceDate }
                fullWidth
                name="invoiceDate"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Due date</span>
            <Input
                type="date"
                bind:value={ $selectedPaymentStore.dueDate }
                fullWidth
                name="dueDate"
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Transaction Id</span>
            <Input
                type="text"
                bind:value={ $selectedPaymentStore.transactionId }
                fullWidth
                name="transactionId"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">Mangopay Id</span>
            <Input
                type="text"
                bind:value={ $selectedPaymentStore.mangopayId }
                fullWidth
                name="mangopayId"
                readonly
            />
        </div>

        <div class="input-row">
            <span class="font-weight-700 line-height-150 color-gray-100">User</span>
            <div style="width: 100%;">
                <UserSelect
                    bind:profile={ $selectedPaymentStore.userProfile }
                    bind:userId={ $selectedPaymentStore.userId }
                    on:change={ handleChange }
                    profileArray={ $profileArrayStore }
                />
            </div>
        </div>
    </form>
</AdminPage>
