<script>
    import { run } from 'svelte/legacy';

    // -- IMPORTS

    import { onMount } from 'svelte';
    import { fetchData } from '$lib/base';
    import { urlParamsStore } from '$store/urlParamsStore';
    import { subscriptionArrayStore } from '$store/subscriptionArrayStore';
    import { subscriptionTypeArrayStore } from '$store/subscriptionTypeArrayStore';
    import { providerArrayStore } from '$store/providerArrayStore';
    import Sidebar from '$component/layout/Sidebar.svelte';
    import SubscriptionList from '$component/page/subscription/SubscriptionList.svelte';

    // -- VARIABLES

    let isLoading = $state(true);
    let currentPage = $state(1);
    let hasMoreSubscriptionsPage = true;

    // -- FUNCTIONS

    async function loadData(
        subscriptionPage = 1
        )
    {
        let data = await fetchData( '/api/admin/page/subscription',
            {
                method: 'POST',
                body: JSON.stringify(
                    {
                        subscriptionPage,
                        documentLimit: 20,
                    }
                    ),
                headers: { 'Content-Type': 'application/json' }
            }
            );

        if ( data && data.subscriptions )
        {
            if ( subscriptionPage > 1 )
            {
                $subscriptionArrayStore = [ ...$subscriptionArrayStore, ...data.subscriptions.subscriptionArray ];
            }
            else
            {
                $subscriptionArrayStore = data.subscriptions.subscriptionArray;
            }

            hasMoreSubscriptionsPage = data.subscriptions.hasMoreSubscriptionsPage;
        }
        else
        {
            $subscriptionArrayStore = [];
        }

        if ( data && data.subscriptionTypeArray )
        {
            $subscriptionTypeArrayStore = data.subscriptionTypeArray;
        }
        else
        {
            $subscriptionTypeArrayStore = [];
        }

        if ( data && data.providerArray )
        {
            $providerArrayStore = data.providerArray;
        }
        else
        {
            $providerArrayStore = [];
        }

        isLoading = false;
    }

    // ~~

    function loadMore(
        )
    {
        if ( !isLoading && hasMoreSubscriptionsPage )
        {
            currentPage++;
            loadData( currentPage );
        }
    }

    // ~~

    function handlePopState(
        )
    {
        loadData( 1 );
        currentPage = 1;
    }

    // -- STATEMENTS

    run(() => {
        $urlParamsStore, loadData( 1 );
    });
    run(() => {
        $urlParamsStore, currentPage = 1;
    });

    // ~~

    onMount(
        () =>
        {
            $subscriptionArrayStore = [];
            window.addEventListener( 'popstate', handlePopState );

            return () =>
            {
                window.removeEventListener( 'popstate', handlePopState );
            };
        }
    );
</script>

<style lang="stylus">
    // -- IMPORTS

    @import '../../../constant.styl';
    @import '../../../mixin.styl';

    // -- CLASSES

    .page-section
    {
        min-height: 100dvh;
        padding-top: 4.5rem;

        display: grid;
        grid-template-columns: min-content 1fr;

        background: pageBackgroundColor;
    }

    .main-section
    {
        display: flex;
        flex-direction: column;
        gap: 1rem;

        background: pageBackgroundColor;
    }
</style>

<div class="page-section">
    <Sidebar />
    <main class="padding-150 main-section">
        {#if isLoading }
            loading...
        {:else}
            <SubscriptionList />
        {/if}
    </main>
</div>
